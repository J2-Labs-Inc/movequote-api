<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoveQuote - Professional Cleaning Business Management</title>
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --primary-light: #d1fae5;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --red-500: #ef4444;
            --red-600: #dc2626;
            --blue-500: #3b82f6;
            --yellow-500: #eab308;
            --sidebar-width: 260px;
            --border-radius-sm: 6px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04), 0 6px 16px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08), 0 16px 32px rgba(0,0,0,0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--gray-800);
            background: var(--gray-50);
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            letter-spacing: -0.02em;
            line-height: 1.2;
            font-weight: 600;
        }

        /* Layout */
        .app {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: #f8fafb;
            border-right: 1px solid var(--gray-200);
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 100;
            transition: transform 0.3s ease;
            box-shadow: 2px 0 8px rgba(0,0,0,0.04);
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            text-decoration: none;
        }

        .logo svg {
            width: 24px;
            height: 24px;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--gray-500);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.25rem;
            display: none;
        }

        .sidebar-toggle:hover {
            background: var(--gray-100);
        }

        .nav-menu {
            padding: 1rem 0;
        }

        .nav-item {
            display: block;
            padding: 0.75rem 1.5rem;
            color: var(--gray-700);
            text-decoration: none;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
            border-radius: 0 var(--border-radius-md) var(--border-radius-md) 0;
            margin: 2px 0 2px 8px;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.8);
            color: var(--gray-900);
            transform: translateX(2px);
        }

        .nav-item.active {
            background: white;
            color: var(--primary-dark);
            border-left: 3px solid var(--primary);
            box-shadow: var(--shadow-sm);
            font-weight: 600;
        }

        .nav-icon {
            font-size: 1.25rem;
            width: 20px;
            text-align: center;
        }

        /* Pro Badge */
        .pro-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            font-size: 0.6rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-weight: 700;
            margin-left: auto;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pro-feature {
            position: relative;
        }

        .pro-feature.locked::after {
            content: 'üîí';
            position: absolute;
            right: 1rem;
            font-size: 0.875rem;
        }

        /* Main Content */
        .main {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s ease;
        }

        .main.expanded {
            margin-left: 0;
        }

        .main-header {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: between;
            gap: 1rem;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--gray-600);
            cursor: pointer;
            padding: 0.75rem;
            border-radius: var(--border-radius-sm);
            min-height: 44px;
            min-width: 44px;
            transition: all 0.2s ease;
        }

        .mobile-menu-btn:hover {
            background: var(--gray-100);
        }

        .main-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            flex: 1;
        }

        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--gray-200);
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            letter-spacing: 0.01em;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            height: 44px;
            padding: 0 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius-md);
            font-size: 1rem;
            transition: all 0.2s ease;
            background: white;
        }

        .form-textarea {
            height: auto;
            padding: 0.75rem 1rem;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1), var(--shadow-sm);
            transform: translateY(-1px);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            white-space: nowrap;
            height: 44px;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px) scale(1.02);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
            transform: translateY(-1px) scale(1.02);
        }

        .btn-outline {
            background: transparent;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
            box-shadow: none;
        }

        .btn-outline:hover {
            background: var(--gray-50);
            transform: translateY(-1px) scale(1.02);
            box-shadow: var(--shadow-sm);
        }

        .btn-danger {
            background: var(--red-500);
            color: white;
        }

        .btn-danger:hover {
            background: var(--red-600);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1rem;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
        }

        .table tr:hover {
            background: var(--gray-50);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 2rem 1.5rem;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--gray-200);
            border-top: 3px solid var(--primary);
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--gray-600);
            font-weight: 500;
        }

        /* Calendar */
        .calendar {
            background: white;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--gray-200);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .calendar-header {
            background: var(--gray-50);
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .calendar-title {
            font-weight: 600;
            color: var(--gray-900);
        }

        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }

        .calendar-nav button {
            background: none;
            border: 1px solid var(--gray-300);
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
            color: var(--gray-700);
        }

        .calendar-nav button:hover {
            background: var(--gray-100);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day-header {
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            color: var(--gray-700);
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .calendar-day {
            min-height: 120px;
            padding: 0.5rem;
            border-right: 1px solid var(--gray-200);
            border-bottom: 1px solid var(--gray-200);
            vertical-align: top;
        }

        .calendar-day-number {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .calendar-event {
            background: var(--primary-light);
            color: var(--primary-dark);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
            cursor: pointer;
        }

        /* Checklist */
        .checklist {
            list-style: none;
        }

        .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .checklist-item:last-child {
            border-bottom: none;
        }

        .checklist-checkbox {
            margin-top: 0.125rem;
        }

        .checklist-content {
            flex: 1;
        }

        .checklist-task {
            font-weight: 500;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .checklist-room {
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
            transform: translateX(400px);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            font-weight: 500;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: var(--red-500);
        }

        /* Getting Started Card */
        .getting-started-card {
            background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
            border: 2px solid #3b82f6;
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .getting-started-dismiss {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: #6b7280;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .getting-started-dismiss:hover {
            background: rgba(0,0,0,0.1);
        }

        .getting-started-steps {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .getting-started-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-radius: var(--border-radius-md);
            border: 1px solid #e5e7eb;
            box-shadow: var(--shadow-sm);
        }

        .getting-started-step-number {
            background: #3b82f6;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .getting-started-step-content {
            flex: 1;
        }

        .getting-started-step-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }

        .getting-started-step-desc {
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        /* Section Labels */
        .form-section {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius-md);
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .form-section-title {
            background: white;
            color: var(--primary-dark);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--primary);
            display: inline-block;
        }

        /* Help Text */
        .help-text {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
            line-height: 1.4;
        }

        /* Form Validation */
        .form-input.error,
        .form-select.error,
        .form-textarea.error {
            border-color: var(--red-500);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        .error-message {
            color: var(--red-500);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Breadcrumbs */
        .breadcrumb {
            color: var(--gray-500);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .breadcrumb .current {
            color: var(--gray-900);
            font-weight: 600;
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-900);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius-sm);
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 0.5rem;
        }

        .tooltip:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: var(--gray-900);
            z-index: 1000;
        }

        /* Keyboard Shortcuts Hint */
        .keyboard-shortcuts {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background: var(--gray-800);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius-sm);
            font-size: 0.875rem;
            cursor: pointer;
            z-index: 1000;
        }

        .keyboard-shortcuts:hover {
            background: var(--gray-700);
        }

        /* Quick Setup Box */
        .quick-setup {
            background: linear-gradient(135deg, var(--primary-light) 0%, #f0fdf4 100%);
            border: 2px solid var(--primary);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .quick-setup-title {
            color: var(--primary-dark);
            font-weight: 600;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-setup-input {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .quick-setup-input input {
            width: 200px;
            font-size: 1.125rem;
            padding: 0.75rem;
        }

        .quick-setup-explanation {
            background: white;
            padding: 1rem;
            border-radius: var(--border-radius-md);
            border-left: 4px solid var(--primary);
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        /* Price Animation */
        .price-animated {
            transition: all 0.3s ease;
            animation: priceUpdate 0.5s ease-out;
        }

        @keyframes priceUpdate {
            0% { 
                transform: scale(1.1); 
                color: var(--primary);
            }
            100% { 
                transform: scale(1); 
            }
        }

        /* Empty State Improvements */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-600);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            opacity: 0.8;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            color: var(--gray-900);
            margin-bottom: 0.75rem;
        }

        .empty-state p {
            margin-bottom: 2rem;
            font-size: 1.1rem;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .empty-state .help-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            margin-top: 1rem;
            display: inline-block;
        }

        .empty-state .help-link:hover {
            text-decoration: underline;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-600);
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: 2rem;
            opacity: 0.6;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            margin-bottom: 1.5rem;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estimate Calculator Specific */
        .calc-summary {
            background: linear-gradient(135deg, var(--primary-light) 0%, #e7f8f3 100%);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin-top: 2rem;
            border: 1px solid rgba(16, 185, 129, 0.2);
            box-shadow: var(--shadow-sm);
        }

        .calc-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .calc-total {
            font-size: 1.5rem;
            font-weight: 700;
            border-top: 2px solid var(--primary);
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Addon Grid */
        .addon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
        }

        .addon-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius-md);
            transition: all 0.2s ease;
            cursor: pointer;
            background: white;
            box-shadow: var(--shadow-sm);
        }

        .addon-item:hover {
            border-color: var(--primary);
            background: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .addon-item input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .addon-item input[type="checkbox"]:checked {
            accent-color: var(--primary);
        }

        .addon-label {
            font-weight: 500;
            color: var(--gray-900);
        }

        .addon-price {
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        /* Proposal Styles */
        .proposal {
            background: white;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .proposal-header {
            background: var(--primary);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .proposal-body {
            padding: 2rem;
        }

        .proposal-section {
            margin-bottom: 2rem;
        }

        .proposal-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .proposal-table th,
        .proposal-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-300);
        }

        .proposal-table th {
            background: var(--gray-50);
            font-weight: 600;
        }

        .proposal-total-row {
            font-weight: 700;
            background: var(--primary-light);
        }

        /* Mobile backdrop */
        .mobile-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .mobile-backdrop.show {
            opacity: 1;
            visibility: visible;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block;
            }

            .sidebar-toggle {
                display: block;
            }

            .main-header {
                padding: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .card {
                padding: 1.5rem;
                margin-bottom: 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 1rem;
            }

            .btn-group {
                flex-direction: column;
                gap: 0.75rem;
            }

            .btn-group .btn {
                width: 100%;
                justify-content: center;
                min-height: 44px;
            }

            .addon-grid {
                grid-template-columns: 1fr;
            }

            .calendar-day {
                min-height: 80px;
            }

            .table {
                font-size: 0.875rem;
            }

            .nav-item {
                padding: 1rem 1.5rem;
                margin: 4px 8px;
            }
        }

        /* Enhanced Mobile - 480px and below */
        @media (max-width: 480px) {
            .main-content {
                padding: 0.75rem;
            }

            .card {
                padding: 1rem;
                border-radius: var(--border-radius-md);
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .card-title {
                font-size: 1.1rem;
            }

            .form-section {
                padding: 1rem;
            }

            .form-section-title {
                font-size: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .stat-label {
                font-size: 0.75rem;
            }

            /* Tables - horizontal scroll wrapper */
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -1rem;
                padding: 0 1rem;
            }

            .table {
                min-width: 500px;
                font-size: 0.8rem;
            }

            .table th,
            .table td {
                padding: 0.75rem 0.5rem;
                white-space: nowrap;
            }

            .table .btn-group {
                flex-direction: row;
                gap: 0.25rem;
            }

            .table .btn-sm {
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
            }

            /* Calculator summary */
            .calc-summary {
                padding: 1.25rem;
            }

            .calc-total {
                font-size: 1.25rem;
            }

            /* Addon grid */
            .addon-item {
                padding: 0.875rem;
            }

            .addon-label {
                font-size: 0.9rem;
            }

            /* Main header mobile */
            .main-header {
                padding: 0.75rem 1rem;
            }

            .main-title {
                font-size: 1.25rem;
            }

            .mobile-menu-btn {
                padding: 0.5rem;
            }

            /* Calendar mobile */
            .calendar-day {
                min-height: 60px;
                padding: 0.25rem;
            }

            .calendar-day-number {
                font-size: 0.75rem;
            }

            .calendar-event {
                font-size: 0.65rem;
                padding: 0.125rem 0.25rem;
            }

            .calendar-header {
                padding: 0.75rem;
            }

            .calendar-nav button {
                padding: 0.375rem 0.5rem;
                font-size: 0.8rem;
            }

            /* Analytics charts mobile */
            #view-analytics > div > div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            /* Empty state */
            .empty-state {
                padding: 2rem 1rem;
            }

            .empty-state-icon {
                font-size: 3rem;
            }

            .empty-state h3 {
                font-size: 1.1rem;
            }

            .empty-state p {
                font-size: 0.95rem;
            }

            /* Proposal mobile */
            .proposal {
                margin: 0;
            }

            .proposal-header {
                padding: 1.25rem;
            }

            .proposal-body {
                padding: 1rem;
            }

            /* Getting started */
            .getting-started-card {
                padding: 1.25rem;
            }

            .getting-started-step {
                padding: 0.75rem;
            }

            .getting-started-step-number {
                width: 28px;
                height: 28px;
                font-size: 0.875rem;
            }

            /* Quick setup */
            .quick-setup {
                padding: 1.25rem;
            }

            .quick-setup-input {
                flex-direction: column;
                align-items: stretch;
            }

            .quick-setup-input input {
                width: 100%;
            }
        }

        /* Very small screens - 375px and below */
        @media (max-width: 375px) {
            :root {
                --sidebar-width: 100%;
            }

            .main-content {
                padding: 0.5rem;
            }

            .card {
                padding: 0.875rem;
            }

            .form-group {
                margin-bottom: 1rem;
            }

            .form-label {
                font-size: 0.8rem;
            }

            .form-input,
            .form-select,
            .form-textarea {
                height: 42px;
                padding: 0 0.75rem;
                font-size: 0.95rem;
            }

            .btn {
                padding: 0.625rem 1rem;
                font-size: 0.8rem;
            }

            .btn-lg {
                padding: 0.875rem 1.25rem;
                font-size: 0.9rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .addon-grid {
                gap: 0.5rem;
            }

            .addon-item {
                padding: 0.75rem;
                gap: 0.5rem;
            }

            .checklist-item {
                padding: 0.5rem 0;
            }

            .calendar-grid {
                font-size: 0.75rem;
            }

            .calendar-day-header {
                padding: 0.5rem 0.25rem;
            }

            /* Ensure no horizontal overflow */
            .main {
                overflow-x: hidden;
            }

            * {
                max-width: 100%;
            }
        }

        /* Touch-friendly targets - all mobile */
        @media (max-width: 768px) {
            /* Minimum 44px touch targets */
            .btn,
            .nav-item,
            .mobile-menu-btn,
            .sidebar-toggle,
            .addon-item,
            .checklist-checkbox,
            input[type="checkbox"],
            input[type="radio"] {
                min-height: 44px;
                min-width: 44px;
            }

            input[type="checkbox"],
            input[type="radio"] {
                width: 20px;
                height: 20px;
            }

            .addon-item input[type="checkbox"] {
                min-width: 20px;
                min-height: 20px;
            }

            /* Improve tap targets for links in tables */
            .table td a,
            .table td button {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-height: 36px;
                min-width: 36px;
            }

            /* Sidebar improvements */
            .sidebar {
                width: 85%;
                max-width: 300px;
            }

            .nav-item {
                min-height: 48px;
                display: flex;
                align-items: center;
            }

            /* Better scroll behavior */
            .main-content {
                -webkit-overflow-scrolling: touch;
            }
        }

        /* Fix tooltip on touch devices - disable hover tooltips on mobile */
        @media (hover: none) and (pointer: coarse) {
            .tooltip:hover::after,
            .tooltip:hover::before {
                display: none !important;
            }
        }
        
        /* Clear tooltips on focus out */
        .tooltip:not(:hover)::after,
        .tooltip:not(:hover)::before {
            display: none;
        }

        /* Fix mobile badge overlap with Quick Actions */
        @media (max-width: 480px) {
            .card .btn-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .card .btn-group .btn {
                width: 100%;
                justify-content: center;
            }
            
            /* Ensure PRO badge doesn't overlap in nav */
            .nav-item {
                flex-wrap: nowrap;
                overflow: visible;
            }
            
            .nav-item .pro-badge {
                position: relative;
                flex-shrink: 0;
            }
            
            /* Dashboard Quick Actions section */
            #view-dashboard .card .btn-group {
                gap: 0.75rem;
            }
            
            #view-dashboard .card .btn-group .btn {
                font-size: 0.875rem;
                padding: 0.875rem 1rem;
            }
        }

        /* Print Styles */
        @media print {
            .sidebar,
            .main-header,
            .btn,
            .card {
                display: none !important;
            }

            .main {
                margin-left: 0;
            }

            .proposal {
                box-shadow: none;
                max-width: none;
            }

            body {
                background: white;
            }

            * {
                color: black !important;
                background: white !important;
            }
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .flex { display: flex; }
        .flex-1 { flex: 1; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 1rem; }
        .w-full { width: 100%; }
        
        /* Settings sections */
        .settings-section {
            background: white;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--gray-200);
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .settings-section h3 {
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
            color: var(--gray-800);
        }
    </style>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="app">
        <!-- Mobile backdrop -->
        <div class="mobile-backdrop" id="mobile-backdrop" onclick="toggleSidebar()"></div>
        
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="#" class="logo">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9.5 13.09l1.41 1.41-6.36 6.37c-.55.55-1.44.55-2 0-.55-.55-.55-1.44 0-2L9.5 13.09zM5.5 11.09l6.36-6.37c.55-.55 1.44-.55 2 0 .55.55.55 1.44 0 2L7.91 12.5 5.5 11.09z" fill="currentColor"/>
                        <path d="M17.5 8c1.38 0 2.5-1.12 2.5-2.5S18.88 3 17.5 3 15 4.12 15 5.5 16.12 8 17.5 8z" fill="currentColor"/>
                        <path d="M12.5 4.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5z" fill="currentColor"/>
                        <path d="M19 21l2-8-2.5-2.5L16 13l3 8z" fill="currentColor"/>
                    </svg>
                    MoveQuote
                </a>
                <button class="sidebar-toggle" onclick="toggleSidebar()">‚úï</button>
            </div>
            <div style="padding: 0.75rem 1.5rem; border-bottom: 1px solid #e5e7eb; margin-bottom: 0.5rem;">
                <div style="font-weight: 600; color: #111827; font-size: 0.875rem;" id="user-display-name"></div>
                <div style="color: #6b7280; font-size: 0.75rem;" id="user-display-email"></div>
            </div>
            <div class="nav-menu">
                <button class="nav-item active tooltip" onclick="showView('dashboard')" id="nav-dashboard" data-tooltip="View your business overview and stats">
                    <span class="nav-icon">üìä</span>
                    Dashboard
                </button>
                <button class="nav-item tooltip pro-feature" onclick="showView('analytics')" id="nav-analytics" data-tooltip="Advanced analytics - Pro feature">
                    <span class="nav-icon">üìà</span>
                    Analytics
                    <span class="pro-badge">PRO</span>
                </button>
                <button class="nav-item tooltip" onclick="showView('estimates')" id="nav-estimates" data-tooltip="Create estimates and quotes for clients">
                    <span class="nav-icon">üßÆ</span>
                    New Estimate
                </button>
                <button class="nav-item tooltip" onclick="showView('proposals')" id="nav-proposals" data-tooltip="View and manage all your proposals">
                    <span class="nav-icon">üìã</span>
                    Proposals
                </button>
                <button class="nav-item tooltip" onclick="showView('clients')" id="nav-clients" data-tooltip="Manage your clients">
                    <span class="nav-icon">üë•</span>
                    Clients
                </button>
                <button class="nav-item tooltip" onclick="showView('schedule')" id="nav-schedule" data-tooltip="View and manage your calendar">
                    <span class="nav-icon">üìÖ</span>
                    Schedule
                </button>
                <button class="nav-item tooltip" onclick="showView('checklists')" id="nav-checklists" data-tooltip="Managemoving checklists">
                    <span class="nav-icon">‚úÖ</span>
                    Checklists
                </button>
                <button class="nav-item tooltip pro-feature" onclick="showView('team')" id="nav-team" data-tooltip="Manage team members - Pro feature">
                    <span class="nav-icon">üë∑</span>
                    Team
                    <span class="pro-badge">PRO</span>
                </button>
                <button class="nav-item tooltip" onclick="showView('settings')" id="nav-settings" data-tooltip="Configure pricing and company info">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    Settings
                </button>
            </div>
            <button onclick="localStorage.removeItem('cq_token'); localStorage.removeItem('cq_user'); window.location.href='index.html';" style="width: calc(100% - 2rem); margin: 1rem; padding: 0.75rem; background: none; border: 1px solid #e5e7eb; border-radius: 0.5rem; color: #6b7280; cursor: pointer; font-size: 0.875rem; transition: all 0.2s;">Sign Out</button>
        </nav>

        <!-- Main Content -->
        <main class="main" id="main">
            <header class="main-header">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
                <div>
                    <div class="breadcrumb" id="breadcrumb">Dashboard</div>
                    <h1 class="main-title" id="main-title">Dashboard</h1>
                </div>
            </header>

            <div class="main-content">
                <!-- Dashboard View -->
                <div id="view-dashboard" class="view">
                    <!-- Getting Started Card for New Users -->
                    <div id="getting-started-card" class="getting-started-card" style="display: none;">
                        <button class="getting-started-dismiss" onclick="dismissGettingStarted()" title="Dismiss this guide">‚úï</button>
                        <h2 style="color: #1e40af; margin-bottom: 0.5rem; font-size: 1.5rem;">üéâ Welcome to MoveQuote!</h2>
                        <p style="color: #4b5563; margin-bottom: 0;">Here's how to get started in 3 simple steps:</p>
                        
                        <div class="getting-started-steps">
                            <div class="getting-started-step">
                                <div class="getting-started-step-number">1</div>
                                <div class="getting-started-step-content">
                                    <div class="getting-started-step-title">Set your pricing</div>
                                    <div class="getting-started-step-desc">Tell us what you charge so we can calculate estimates automatically</div>
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="showView('settings')">Go to Settings</button>
                            </div>
                            
                            <div class="getting-started-step">
                                <div class="getting-started-step-number">2</div>
                                <div class="getting-started-step-content">
                                    <div class="getting-started-step-title">Create your first estimate</div>
                                    <div class="getting-started-step-desc">Use our calculator to quote amoving job</div>
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="showView('estimates')">New Estimate</button>
                            </div>
                            
                            <div class="getting-started-step">
                                <div class="getting-started-step-number">3</div>
                                <div class="getting-started-step-content">
                                    <div class="getting-started-step-title">Send it to a client</div>
                                    <div class="getting-started-step-desc">Share your professional proposal and get paid</div>
                                </div>
                                <button class="btn btn-secondary btn-sm" onclick="showView('proposals')">View Proposals</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-revenue">$0</div>
                            <div class="stat-label">Monthly Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-estimates">0</div>
                            <div class="stat-label">Estimates This Month</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-conversion">0%</div>
                            <div class="stat-label">Conversion Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-clients">0</div>
                            <div class="stat-label">Unique Clients</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Quick Actions</h2>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="showView('estimates')">
                                üìä New Estimate
                            </button>
                            <button class="btn btn-secondary" onclick="showView('proposals')">
                                üìã View Proposals
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Recent Estimates</h2>
                        </div>
                        <div id="recent-estimates">
                            <div class="empty-state">
                                <div class="empty-state-icon">üßÆ</div>
                                <h3>No estimates yet</h3>
                                <p>Create your first estimate to track your progress.</p>
                                <button class="btn btn-primary" onclick="showView('estimates')">Create Estimate</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics View (Pro Feature) -->
                <div id="view-analytics" class="view hidden">
                    <div id="analytics-upgrade-prompt" class="card" style="display: none;">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìà</div>
                            <h3>Advanced Analytics - Pro Feature</h3>
                            <p>Get detailed insights into your business performance with charts, trends, and revenue tracking.</p>
                            <ul style="text-align: left; max-width: 400px; margin: 0 auto 1.5rem;">
                                <li>Quote volume trends</li>
                                <li>Status breakdown charts</li>
                                <li>Revenue tracking over time</li>
                                <li>Conversion rate analysis</li>
                            </ul>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                                <a href="https://buy.stripe.com/5kQ5kF91QcJhaI250I1sQ00" class="btn btn-primary btn-lg">Upgrade Monthly - $29/mo</a>
                                <a href="https://buy.stripe.com/fZu4gBema4cL6rMdxe1sQ02" class="btn btn-outline" style="font-size: 0.9rem;">Or save $58 with Annual - $290/yr</a>
                            </div>
                        </div>
                    </div>

                    <div id="analytics-dashboard" style="display: none;">
                        <!-- Summary Stats -->
                        <div class="stats-grid" style="margin-bottom: 2rem;">
                            <div class="stat-card">
                                <div class="stat-value" id="stat-total-quotes">-</div>
                                <div class="stat-label">Total Quotes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-this-month">-</div>
                                <div class="stat-label">This Month</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-this-week">-</div>
                                <div class="stat-label">This Week</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-conversion">-</div>
                                <div class="stat-label">Conversion Rate</div>
                            </div>
                        </div>

                        <!-- Revenue Cards -->
                        <div class="stats-grid" style="margin-bottom: 2rem;">
                            <div class="stat-card" style="border-top-color: #3b82f6;">
                                <div class="stat-value" style="color: #3b82f6;" id="stat-total-quoted">$0</div>
                                <div class="stat-label">Total Quoted Value</div>
                            </div>
                            <div class="stat-card" style="border-top-color: #10b981;">
                                <div class="stat-value" style="color: #10b981;" id="stat-accepted-value">$0</div>
                                <div class="stat-label">Accepted Value</div>
                            </div>
                            <div class="stat-card" style="border-top-color: #8b5cf6;">
                                <div class="stat-value" style="color: #8b5cf6;" id="stat-avg-quote">$0</div>
                                <div class="stat-label">Avg Quote Value</div>
                            </div>
                        </div>

                        <!-- Charts Row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                            <!-- Status Breakdown Chart -->
                            <div class="card">
                                <h3 class="card-title" style="margin-bottom: 1rem;">Quote Status Breakdown</h3>
                                <div style="height: 280px; position: relative;">
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>

                            <!-- Monthly Trend Chart -->
                            <div class="card">
                                <h3 class="card-title" style="margin-bottom: 1rem;">Monthly Quote Trend</h3>
                                <div style="height: 280px; position: relative;">
                                    <canvas id="trendChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Revenue Trend -->
                        <div class="card">
                            <h3 class="card-title" style="margin-bottom: 1rem;">Revenue Trend (Last 6 Months)</h3>
                            <div style="height: 300px; position: relative;">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estimates View -->
                <div id="view-estimates" class="view hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">New Cleaning Estimate</h2>
                            <button class="btn btn-secondary" onclick="clearEstimate()">Clear Form</button>
                        </div>

                        <form id="estimate-form">
                            <div style="background: #f8fafb; padding: 1.5rem; border-radius: var(--border-radius-md); margin-bottom: 2rem;">
                                <h3 style="margin: 0 0 1.5rem 0; color: var(--gray-800); font-size: 1.1rem;">Client & Property Information</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label" for="client-name">Client Name *</label>
                                        <input type="text" id="client-name" class="form-input" placeholder="Enter client name" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="property-address">Property Address *</label>
                                        <input type="text" id="property-address" class="form-input" placeholder="Enter property address" required>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label" for="property-type">Property Type *</label>
                                        <select id="property-type" class="form-select" required>
                                            <option value="">Select property type</option>
                                            <option value="residential">Residential</option>
                                            <option value="commercial">Commercial</option>
                                            <option value="airbnb">Airbnb/Vacation Rental</option>
                                            <option value="move-inout">Move-in/Move-out</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="service-type">Service Type *</label>
                                        <select id="service-type" class="form-select" required>
                                            <option value="">Select service type</option>
                                            <option value="standard">Standard Clean</option>
                                            <option value="deep">Deep Clean</option>
                                            <option value="move-out">Move-in/Move-out</option>
                                            <option value="post-construction">Post-Construction</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div style="background: white; padding: 1.5rem; border-radius: var(--border-radius-md); border: 1px solid var(--gray-200); margin-bottom: 2rem;">
                                <h3 style="margin: 0 0 1.5rem 0; color: var(--gray-800); font-size: 1.1rem;">Property Details & Pricing</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Pricing Method</label>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-outline" id="pricing-sqft" onclick="setPricingMethod('sqft')">Square Footage</button>
                                            <button type="button" class="btn btn-primary" id="pricing-rooms" onclick="setPricingMethod('rooms')">Room by Room</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Square Footage Method -->
                                <div id="sqft-method" class="form-group hidden">
                                    <label class="form-label" for="square-footage">Square Footage</label>
                                    <input type="number" id="square-footage" class="form-input" placeholder="e.g. 1500">
                                </div>

                                <!-- Room Method -->
                                <div id="rooms-method">
                                    <label class="form-label">Rooms</label>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label" for="bedrooms">Bedrooms</label>
                                            <input type="number" id="bedrooms" class="form-input" min="0" value="0">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="bathrooms">Bathrooms</label>
                                            <input type="number" id="bathrooms" class="form-input" min="0" value="0" step="0.5">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="kitchen">Kitchen</label>
                                            <input type="number" id="kitchen" class="form-input" min="0" value="0">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="living-areas">Living Areas</label>
                                            <input type="number" id="living-areas" class="form-input" min="0" value="0">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="background: #f8fafb; padding: 1.5rem; border-radius: var(--border-radius-md); margin-bottom: 2rem;">
                                <h3 style="margin: 0 0 1.5rem 0; color: var(--gray-800); font-size: 1.1rem;">Schedule & Services</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label" for="frequency">Frequency</label>
                                        <select id="frequency" class="form-select">
                                            <option value="one-time">One-time</option>
                                            <option value="weekly">Weekly (15% discount)</option>
                                            <option value="biweekly">Bi-weekly (10% discount)</option>
                                            <option value="monthly">Monthly (5% discount)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="start-date">Start Date</label>
                                        <input type="date" id="start-date" class="form-input">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Add-on Services</label>
                                    <div class="addon-grid" id="addon-services">
                                        <!-- Add-ons will be populated by JavaScript -->
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="special-notes">Special Notes</label>
                                    <textarea id="special-notes" class="form-textarea" placeholder="Any special requirements or notes..."></textarea>
                                </div>
                            </div>

                            <div class="calc-summary">
                                <div class="calc-line">
                                    <span>Base Service:</span>
                                    <span id="base-price">$0.00</span>
                                </div>
                                <div class="calc-line">
                                    <span>Add-on Services:</span>
                                    <span id="addon-total">$0.00</span>
                                </div>
                                <div class="calc-line">
                                    <span>Frequency Discount:</span>
                                    <span id="discount-amount">$0.00</span>
                                </div>
                                <div class="calc-line">
                                    <span>Subtotal:</span>
                                    <span id="subtotal">$0.00</span>
                                </div>
                                <div class="calc-line">
                                    <span>Tax:</span>
                                    <span id="tax-amount">$0.00</span>
                                </div>
                                <div class="calc-line calc-total">
                                    <span>Total:</span>
                                    <span id="total-amount">$0.00</span>
                                </div>
                            </div>

                            <div class="btn-group mt-3">
                                <button type="button" class="btn btn-secondary" onclick="previewProposal()" style="background: #6366f1; color: white;">üëÄ Preview Proposal</button>
                                <button type="submit" class="btn btn-primary btn-lg" style="background: linear-gradient(135deg, var(--primary) 0%, #059669 100%); font-weight: 700; box-shadow: var(--shadow-md);">üöÄ Generate Proposal</button>
                                <button type="button" class="btn btn-secondary" onclick="saveEstimate()">Save Draft</button>
                                <button type="button" class="btn btn-outline" onclick="printEstimate()">Print</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Proposals View -->
                <div id="view-proposals" class="view hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Saved Proposals</h2>
                            <button class="btn btn-primary" onclick="showView('estimates')">New Estimate</button>
                        </div>
                        <div id="proposals-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìã</div>
                                <h3>No proposals yet</h3>
                                <p>Create your first estimate to generate a proposal.</p>
                                <button class="btn btn-primary" onclick="showView('estimates')">Create Estimate</button>
                            </div>
                        </div>
                    </div>

                    <!-- Proposal Preview -->
                    <div id="proposal-preview" class="hidden">
                        <div class="proposal">
                            <div class="proposal-header" id="proposal-header-styled">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <img id="proposal-logo" style="width: 60px; height: 60px; object-fit: contain; border-radius: 8px; display: none;">
                                    <div>
                                        <h1 style="margin: 0; font-size: 1.5rem;">Cleaning Service Proposal</h1>
                                        <h2 id="proposal-company-name" style="margin: 0.25rem 0 0 0; font-size: 1.1rem; font-weight: 600;">Your Cleaning Company</h2>
                                    </div>
                                </div>
                                <p id="proposal-company-contact" style="margin-top: 0.5rem; font-size: 0.875rem; opacity: 0.9;">phone ‚Ä¢ email ‚Ä¢ address</p>
                            </div>
                            <div class="proposal-body">
                                <div class="proposal-section">
                                    <h3>Client Information</h3>
                                    <p><strong>Name:</strong> <span id="proposal-client-name"></span></p>
                                    <p><strong>Property Address:</strong> <span id="proposal-property-address"></span></p>
                                    <p><strong>Date:</strong> <span id="proposal-date"></span></p>
                                </div>

                                <div class="proposal-section">
                                    <h3>Service Details</h3>
                                    <table class="proposal-table">
                                        <thead>
                                            <tr>
                                                <th>Service</th>
                                                <th>Description</th>
                                                <th>Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody id="proposal-services">
                                            <!-- Services will be populated by JavaScript -->
                                        </tbody>
                                        <tfoot>
                                            <tr class="proposal-total-row">
                                                <td colspan="2"><strong>Total Amount</strong></td>
                                                <td><strong id="proposal-total"></strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                <div class="proposal-section">
                                    <h3>Terms & Conditions</h3>
                                    <div id="proposal-terms">
                                        <p>‚Ä¢ Payment is due upon completion of services</p>
                                        <p>‚Ä¢ Client must provide access to property at scheduled time</p>
                                        <p>‚Ä¢ Cancellations require 24-hour notice</p>
                                        <p>‚Ä¢ We are fully insured and bonded</p>
                                    </div>
                                </div>

                                <div class="proposal-section">
                                    <p><strong>This proposal is valid for 30 days from the date above.</strong></p>
                                    <p>Thank you for considering our services. We look forward to working with you!</p>
                                </div>

                                <div class="proposal-section text-center">
                                    <div class="btn-group">
                                        <button class="btn btn-primary">Accept Proposal</button>
                                        <button class="btn btn-secondary">Request Changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="printProposal()">Print PDF</button>
                                <button class="btn btn-outline" onclick="editProposal()">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Clients View -->
                <div id="view-clients" class="view hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Clients</h2>
                            <button class="btn btn-primary" onclick="showAddClientModal()">+ Add Client</button>
                        </div>
                        <div id="clients-list">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Schedule View -->
                <div id="view-schedule" class="view hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Schedule</h2>
                        </div>
                        <div class="calendar" id="calendar-container">
                            <div class="calendar-header">
                                <button class="btn btn-outline btn-sm" onclick="navigateCalendar(-1)">‚Üê Prev</button>
                                <span class="calendar-title" id="calendar-month-title"></span>
                                <button class="btn btn-outline btn-sm" onclick="navigateCalendar(1)">Next ‚Üí</button>
                            </div>
                            <div class="calendar-grid" id="calendar-grid">
                                <!-- Calendar will be rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upcoming Jobs -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h2 class="card-title">Upcoming Jobs</h2>
                        </div>
                        <div id="upcoming-jobs-list">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Checklists View -->
                <div id="view-checklists" class="view hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Checklist Templates</h2>
                            <button class="btn btn-primary" onclick="showAddChecklistModal()">+ Create Template</button>
                        </div>
                        <div id="checklists-list">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Team View (Pro) -->
                <div id="view-team" class="view hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Team Members</h2>
                            <button class="btn btn-primary" onclick="showAddTeamMemberModal()">+ Add Team Member</button>
                        </div>
                        <div id="team-upgrade-prompt" style="display: none;">
                            <div class="empty-state">
                                <div class="empty-state-icon">üë∑</div>
                                <h3>Team Management - Pro Feature</h3>
                                <p>Add team members and assign jobs to yourmoving crew.</p>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center;">
                                    <a href="https://buy.stripe.com/5kQ5kF91QcJhaI250I1sQ00" class="btn btn-primary">Upgrade to Pro - $29/mo</a>
                                </div>
                            </div>
                        </div>
                        <div id="team-list" style="display: none;">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>

                <!-- Settings View -->
                <div id="view-settings" class="view hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Company Information</h2>
                        </div>
                        <form id="company-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="company-name">Company Name</label>
                                    <input type="text" id="company-name" class="form-input" placeholder="Your Cleaning Company">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="company-phone">Phone</label>
                                    <input type="tel" id="company-phone" class="form-input" placeholder="(555) 123-4567">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="company-email">Email</label>
                                    <input type="email" id="company-email" class="form-input" placeholder="info@yourcompany.com">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="company-website">Website</label>
                                    <input type="url" id="company-website" class="form-input" placeholder="www.yourcompany.com">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="company-address">Address</label>
                                <textarea id="company-address" class="form-textarea" placeholder="Your business address..."></textarea>
                            </div>
                        </form>
                    </div>

                    <!-- Custom Branding Section (Pro Feature) -->
                    <div class="card" id="branding-section">
                        <div class="card-header">
                            <h2 class="card-title">
                                Custom Branding
                                <span class="pro-badge">PRO</span>
                            </h2>
                        </div>
                        
                        <!-- Upgrade prompt for free users -->
                        <div id="branding-upgrade-prompt" style="display: none;">
                            <div class="empty-state" style="padding: 2rem;">
                                <div class="empty-state-icon">üé®</div>
                                <h3>Custom Branding - Pro Feature</h3>
                                <p>Add your logo and brand colors to make your proposals look professional.</p>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center;">
                                    <a href="https://buy.stripe.com/5kQ5kF91QcJhaI250I1sQ00" class="btn btn-primary">Monthly - $29/mo</a>
                                    <a href="https://buy.stripe.com/fZu4gBema4cL6rMdxe1sQ02" class="btn btn-outline">Annual - $290/yr</a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Branding form for Pro users -->
                        <div id="branding-form-container" style="display: none;">
                            <form id="branding-form">
                                <!-- Logo Upload -->
                                <div class="form-group">
                                    <label class="form-label">Company Logo</label>
                                    <div id="logo-preview-container" style="margin-bottom: 1rem;">
                                        <div id="logo-placeholder" style="width: 150px; height: 150px; border: 2px dashed var(--gray-300); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--gray-500); font-size: 0.875rem; background: var(--gray-50);">
                                            No logo uploaded
                                        </div>
                                        <img id="logo-preview" style="max-width: 150px; max-height: 150px; border-radius: 8px; display: none; border: 1px solid var(--gray-200);" />
                                    </div>
                                    <div class="btn-group" style="flex-direction: row;">
                                        <label class="btn btn-secondary" style="cursor: pointer;">
                                            <span>üì∑ Upload Logo</span>
                                            <input type="file" id="logo-upload" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                                        </label>
                                        <button type="button" class="btn btn-outline" onclick="removeLogo()" id="remove-logo-btn" style="display: none;">Remove</button>
                                    </div>
                                    <p class="help-text" style="margin-top: 0.5rem;">Recommended: Square image, 150x150px or larger. Max 500KB.</p>
                                </div>
                                
                                <!-- Brand Color -->
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label" for="brand-color">Brand Color</label>
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <input type="color" id="brand-color" value="#10b981" style="width: 60px; height: 44px; border: 1px solid var(--gray-300); border-radius: 8px; cursor: pointer; padding: 2px;">
                                            <input type="text" id="brand-color-hex" class="form-input" value="#10b981" style="width: 120px; font-family: monospace;" onchange="syncColorFromHex()">
                                            <div id="color-preview" style="width: 100px; height: 44px; border-radius: 8px; background: #10b981;"></div>
                                        </div>
                                        <p class="help-text">This color will be used in your proposals header and accents.</p>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="company-display-name">Display Name on Proposals</label>
                                        <input type="text" id="company-display-name" class="form-input" placeholder="Your Company Name">
                                        <p class="help-text">This name will appear on your proposals. Leave blank to use your account business name.</p>
                                    </div>
                                </div>
                                
                                <!-- Preview -->
                                <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                                    <h4 style="margin-bottom: 1rem; color: var(--gray-700);">Proposal Header Preview</h4>
                                    <div id="branding-preview" style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 8px;" id="preview-header">
                                            <div id="preview-logo" style="width: 60px; height: 60px; background: var(--gray-200); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--gray-500); font-size: 0.75rem;">Logo</div>
                                            <div>
                                                <div id="preview-company-name" style="font-weight: 700; font-size: 1.25rem; color: white;">Your Company</div>
                                                <div style="font-size: 0.875rem; color: rgba(255,255,255,0.8);">Professional Cleaning Services</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 1.5rem;">
                                    <button type="button" class="btn btn-primary" onclick="saveBranding()">Save Branding</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Quick Setup for New Users -->
                    <div class="quick-setup">
                        <div class="quick-setup-title">
                            ‚ö° Quick Setup Mode
                        </div>
                        <p style="color: var(--gray-700); margin-bottom: 1.5rem;">New to MoveQuote? Set your hourly rate and we'll calculate everything else based on industry standards!</p>
                        
                        <div class="quick-setup-input">
                            <label style="font-weight: 600; color: var(--gray-700);">What do you charge per hour?</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.25rem;">$</span>
                                <input type="number" id="hourly-rate" class="form-input quick-setup-input" placeholder="25" style="width: 120px;" oninput="calculateFromHourlyRate()">
                                <span style="color: var(--gray-600);">per hour</span>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="applyQuickSetup()">Auto-Fill My Rates</button>
                        </div>
                        
                        <div class="quick-setup-explanation">
                            <strong>How it works:</strong> We'll automatically set your per-room and square-foot rates based on your hourly rate and typicalmoving times. You can always adjust them manually below.
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Pricing Configuration</h2>
                            <div style="font-size: 0.875rem; color: var(--gray-600);">Or set your rates manually:</div>
                        </div>
                        <form id="pricing-form">
                            <div class="settings-section">
                                <h3>Square Footage Rates</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="rate-residential-standard">Residential Standard (per sq ft)</label>
                                    <input type="number" id="rate-residential-standard" class="form-input" step="0.01" placeholder="0.10">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="rate-residential-deep">Residential Deep Clean (per sq ft)</label>
                                    <input type="number" id="rate-residential-deep" class="form-input" step="0.01" placeholder="0.15">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="rate-commercial-standard">Commercial Standard (per sq ft)</label>
                                    <input type="number" id="rate-commercial-standard" class="form-input" step="0.01" placeholder="0.08">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="rate-commercial-deep">Commercial Deep Clean (per sq ft)</label>
                                    <input type="number" id="rate-commercial-deep" class="form-input" step="0.01" placeholder="0.12">
                                </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h3>Room-Based Rates</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="rate-bedroom">Bedroom</label>
                                    <input type="number" id="rate-bedroom" class="form-input" placeholder="25">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="rate-bathroom">Bathroom</label>
                                    <input type="number" id="rate-bathroom" class="form-input" placeholder="35">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="rate-kitchen">Kitchen</label>
                                    <input type="number" id="rate-kitchen" class="form-input" placeholder="50">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="rate-living">Living Area</label>
                                    <input type="number" id="rate-living" class="form-input" placeholder="30">
                                </div>
                                </div>
                            </div>

                            <div class="settings-section">
                                <h3>Frequency Discounts</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="discount-weekly">Weekly (%)</label>
                                    <input type="number" id="discount-weekly" class="form-input" placeholder="15">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="discount-biweekly">Bi-weekly (%)</label>
                                    <input type="number" id="discount-biweekly" class="form-input" placeholder="10">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="discount-monthly">Monthly (%)</label>
                                    <input type="number" id="discount-monthly" class="form-input" placeholder="5">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="tax-rate">Tax Rate (%)</label>
                                    <input type="number" id="tax-rate" class="form-input" step="0.01" placeholder="8.25">
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Add-on Services</h2>
                            <button class="btn btn-primary" onclick="addAddonService()">Add Service</button>
                        </div>
                        <div id="addon-services-config">
                            <!-- Add-on services will be populated by JavaScript -->
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Terms & Conditions</h2>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="terms-conditions">Default Terms & Conditions</label>
                            <textarea id="terms-conditions" class="form-textarea" style="min-height: 150px;" placeholder="Enter your standard terms and conditions...">Payment is due upon completion of services.
Client must provide access to property at scheduled time.
Cancellations require 24-hour notice.
We are fully insured and bonded.</textarea>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Data Management</h2>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="exportData()">Export Data (JSON)</button>
                            <button class="btn btn-outline" onclick="importData()">Import Data</button>
                            <input type="file" id="import-file" accept=".json" style="display: none;" onchange="handleImport()">
                        </div>
                    </div>

                    <div class="btn-group mt-3">
                        <button class="btn btn-primary" onclick="saveSettings()">Save All Settings</button>
                        <button class="btn btn-danger" onclick="resetSettings()">Reset to Defaults</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>

    <!-- Keyboard Shortcuts Hint -->
    <div class="keyboard-shortcuts" onclick="showKeyboardShortcuts()">
        Press ? for shortcuts
    </div>

    <!-- TODO: Stripe Integration -->
    <!-- 
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // TODO: Add your Stripe publishable key here
        const stripe = Stripe('pk_test_your_publishable_key_here');
        
        // TODO: Implement checkout session creation
        async function createCheckoutSession(priceId) {
            const response = await fetch('/create-checkout-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ priceId: priceId })
            });
            
            const session = await response.json();
            
            // Redirect to Stripe Checkout
            const result = await stripe.redirectToCheckout({
                sessionId: session.id
            });
            
            if (result.error) {
                console.error(result.error.message);
            }
        }
        
        // TODO: Add pricing table with Stripe Price IDs
        const pricingTable = [
            {
                name: 'Professional Monthly',
                priceId: 'price_monthly_professional_id_here',
                amount: '$29'
            },
            {
                name: 'Professional Annual',
                priceId: 'price_annual_professional_id_here',
                amount: '$249'
            }
        ];
    </script>
    -->

    <script>
        // ============================================
        // API CONFIGURATION
        // ============================================
        const API_URL = 'https://api-production-9bf9.up.railway.app';

        // Auth headers helper
        const authHeaders = () => ({
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('cq_token')}`
        });

        // ============================================
        // AUTH GATE - Verify token with API
        // ============================================
        let cqUser = {};
        
        async function checkAuth() {
            const token = localStorage.getItem('cq_token');
            if (!token) {
                window.location.href = 'auth.html?mode=login';
                return false;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/auth/me`, {
                    headers: authHeaders()
                });
                
                if (!response.ok) {
                    localStorage.removeItem('cq_token');
                    localStorage.removeItem('cq_user');
                    window.location.href = 'auth.html?mode=login';
                    return false;
                }
                
                const data = await response.json();
                cqUser = data.user;
                localStorage.setItem('cq_user', JSON.stringify(cqUser));
                
                // Populate user info in sidebar
                const userNameEl = document.getElementById('user-display-name');
                const userEmailEl = document.getElementById('user-display-email');
                if (userNameEl) userNameEl.textContent = cqUser.name || 'User';
                if (userEmailEl) userEmailEl.textContent = cqUser.email || '';
                
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'auth.html?mode=login';
                return false;
            }
        }

        // Populate user info (fallback from localStorage while checking)
        const storedUser = JSON.parse(localStorage.getItem('cq_user') || '{}');
        const userNameEl = document.getElementById('user-display-name');
        const userEmailEl = document.getElementById('user-display-email');
        if (userNameEl) userNameEl.textContent = storedUser.name || storedUser.fullName || 'User';
        if (userEmailEl) userEmailEl.textContent = storedUser.email || '';

        // Application State
        let appData = {
            estimates: [],
            clients: [],
            schedules: [],
            checklists: [],
            settings: {
                company: {
                    name: 'Your Cleaning Company',
                    phone: '(555) 123-4567',
                    email: 'info@yourcompany.com',
                    address: '',
                    website: ''
                },
                pricing: {
                    sqft: {
                        residential: { standard: 0.10, deep: 0.15 },
                        commercial: { standard: 0.08, deep: 0.12 },
                        airbnb: { standard: 0.12, deep: 0.18 },
                        moveout: 0.20
                    },
                    rooms: {
                        bedroom: 25,
                        bathroom: 35,
                        kitchen: 50,
                        living: 30
                    },
                    discounts: {
                        weekly: 15,
                        biweekly: 10,
                        monthly: 5
                    },
                    tax: 8.25
                },
                addons: [
                    { name: 'Inside Fridge', price: 25 },
                    { name: 'Inside Oven', price: 25 },
                    { name: 'Interior Windows', price: 50 },
                    { name: 'Laundry Service', price: 30 },
                    { name: 'Organize Closets', price: 40 },
                    { name: 'Garage Cleaning', price: 75 },
                    { name: 'Basement Cleaning', price: 60 },
                    { name: 'Carpet Cleaning', price: 100 }
                ],
                terms: 'Payment is due upon completion of services.\nClient must provide access to property at scheduled time.\nCancellations require 24-hour notice.\nWe are fully insured and bonded.'
            }
        };

        // Current state
        let currentView = 'dashboard';
        let currentPricingMethod = 'rooms';

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            const isAuthed = await checkAuth();
            if (!isAuthed) return;
            
            await loadData();
            initializeApp();
            updateDashboard();
            checkShowGettingStarted();
        });

        // ============================================
        // API DATA PERSISTENCE
        // ============================================
        
        // Save local settings to localStorage (settings stay local for now)
        function saveLocalSettings() {
            const localData = {
                clients: appData.clients,
                schedules: appData.schedules,
                checklists: appData.checklists,
                settings: appData.settings
            };
            localStorage.setItem('cleanlyquote-local-data', JSON.stringify(localData));
        }
        
        // Legacy saveData for backward compatibility (settings only)
        function saveData() {
            saveLocalSettings();
        }

        // Load data from API and localStorage
        async function loadData() {
            // Load local settings from localStorage
            const savedLocal = localStorage.getItem('cleanlyquote-local-data');
            if (savedLocal) {
                const parsedLocal = JSON.parse(savedLocal);
                appData.clients = parsedLocal.clients || [];
                appData.schedules = parsedLocal.schedules || [];
                appData.checklists = parsedLocal.checklists || [];
                appData.settings = { ...appData.settings, ...parsedLocal.settings };
            }
            
            // Also check old localStorage key for migration
            const savedOld = localStorage.getItem('cleanlyquote-data');
            if (savedOld && !savedLocal) {
                const parsedOld = JSON.parse(savedOld);
                appData.clients = parsedOld.clients || [];
                appData.schedules = parsedOld.schedules || [];
                appData.checklists = parsedOld.checklists || [];
                appData.settings = { ...appData.settings, ...parsedOld.settings };
                // Migrate to new key
                saveLocalSettings();
            }
            
            // Load quotes from API
            try {
                const response = await fetch(`${API_URL}/api/quotes`, {
                    headers: authHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    appData.estimates = data.quotes || [];
                }
            } catch (error) {
                console.error('Failed to load quotes from API:', error);
                showToast('Failed to load quotes. Some data may be unavailable.', 'error');
            }
        }
        
        // ============================================
        // QUOTE API FUNCTIONS
        // ============================================
        
        async function createQuoteAPI(quoteData) {
            try {
                const response = await fetch(`${API_URL}/api/quotes`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify(quoteData)
                });
                
                const data = await response.json();
                
                if (response.status === 403 && data.code === 'UPGRADE_REQUIRED') {
                    showUpgradeModal(data.message, data.checkoutUrl);
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create quote');
                }
                
                return data.quote;
            } catch (error) {
                console.error('Create quote error:', error);
                showToast(error.message, 'error');
                return null;
            }
        }
        
        async function updateQuoteAPI(quoteId, quoteData) {
            try {
                const response = await fetch(`${API_URL}/api/quotes/${quoteId}`, {
                    method: 'PUT',
                    headers: authHeaders(),
                    body: JSON.stringify(quoteData)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to update quote');
                }
                
                return data.quote;
            } catch (error) {
                console.error('Update quote error:', error);
                showToast(error.message, 'error');
                return null;
            }
        }
        
        async function deleteQuoteAPI(quoteId) {
            try {
                const response = await fetch(`${API_URL}/api/quotes/${quoteId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to delete quote');
                }
                
                return true;
            } catch (error) {
                console.error('Delete quote error:', error);
                showToast(error.message, 'error');
                return false;
            }
        }
        
        // ============================================
        // UPGRADE MODAL
        // ============================================
        
        function showUpgradeModal(message, checkoutUrl) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('upgrade-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'upgrade-modal';
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 480px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                            <div style="text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üöÄ</div>
                                <h2 style="color: #111827; margin-bottom: 0.5rem; font-size: 1.5rem;">Upgrade to Pro</h2>
                                <p id="upgrade-message" style="color: #6b7280; margin-bottom: 1.5rem;"></p>
                                <div style="background: linear-gradient(135deg, #d1fae5, #ecfdf5); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                    <div style="font-weight: 600; color: #059669;">Pro Plan Benefits:</div>
                                    <ul style="text-align: left; color: #374151; margin: 0.5rem 0; padding-left: 1.5rem; font-size: 0.9rem;">
                                        <li>Unlimited quotes</li>
                                        <li>Priority support</li>
                                        <li>Advanced analytics</li>
                                        <li>Custom branding</li>
                                    </ul>
                                </div>
                                <div style="display: flex; gap: 0.75rem; justify-content: center;">
                                    <button onclick="closeUpgradeModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; color: #6b7280;">Maybe Later</button>
                                    <button id="upgrade-btn" onclick="redirectToCheckout()" style="padding: 0.75rem 1.5rem; border: none; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);">Upgrade Now ‚Üí</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('upgrade-message').textContent = message || 'You\'ve reached the free plan limit. Upgrade to create unlimited quotes!';
            modal.dataset.checkoutUrl = checkoutUrl || '';
            modal.style.display = 'block';
        }
        
        function closeUpgradeModal() {
            const modal = document.getElementById('upgrade-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        async function redirectToCheckout() {
            const modal = document.getElementById('upgrade-modal');
            let checkoutUrl = modal?.dataset.checkoutUrl;
            
            if (!checkoutUrl) {
                // Create checkout session via API
                try {
                    const response = await fetch(`${API_URL}/api/subscription/create-checkout`, {
                        method: 'POST',
                        headers: authHeaders()
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.url) {
                        checkoutUrl = data.url;
                    } else {
                        throw new Error(data.error || 'Failed to create checkout session');
                    }
                } catch (error) {
                    console.error('Checkout error:', error);
                    showToast('Failed to start checkout. Please try again.', 'error');
                    return;
                }
            }
            
            if (checkoutUrl) {
                window.location.href = checkoutUrl;
            }
        }

        // Navigation
        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });

            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected view
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            document.getElementById(`nav-${viewName}`).classList.add('active');

            // Update main title and breadcrumb
            const pages = {
                dashboard: { title: 'Dashboard', breadcrumb: 'Dashboard' },
                analytics: { title: 'Analytics', breadcrumb: 'Dashboard > Analytics' },
                estimates: { title: 'New Estimate', breadcrumb: 'Dashboard > New Estimate' },
                proposals: { title: 'Proposals', breadcrumb: 'Dashboard > Proposals' },
                clients: { title: 'Clients', breadcrumb: 'Dashboard > Clients' },
                schedule: { title: 'Schedule', breadcrumb: 'Dashboard > Schedule' },
                checklists: { title: 'Checklists', breadcrumb: 'Dashboard > Checklists' },
                team: { title: 'Team', breadcrumb: 'Dashboard > Team' },
                settings: { title: 'Settings', breadcrumb: 'Dashboard > Settings' }
            };
            
            const page = pages[viewName] || { title: viewName, breadcrumb: viewName };
            document.getElementById('main-title').textContent = page.title;
            document.getElementById('breadcrumb').innerHTML = page.breadcrumb.split(' > ').map((item, index, arr) => 
                index === arr.length - 1 ? `<span class="current">${item}</span>` : item
            ).join(' > ');
            
            currentView = viewName;

            // Load view-specific data
            switch(viewName) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'estimates':
                    initializeEstimateForm();
                    break;
                case 'proposals':
                    loadProposals();
                    break;
                case 'clients':
                    loadClients();
                    break;
                case 'schedule':
                    loadSchedule();
                    break;
                case 'checklists':
                    loadChecklists();
                    break;
                case 'team':
                    loadTeam();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // Sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const main = document.getElementById('main');
            const backdrop = document.getElementById('mobile-backdrop');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('show');
                backdrop.classList.toggle('show');
                document.body.style.overflow = sidebar.classList.contains('show') ? 'hidden' : '';
            } else {
                sidebar.classList.toggle('collapsed');
                main.classList.toggle('expanded');
            }
        }

        // Initialize app
        function initializeApp() {
            // Set today's date as default
            document.getElementById('start-date').valueAsDate = new Date();

            // Add event listeners
            document.getElementById('estimate-form').addEventListener('submit', handleEstimateSubmit);

            // Add estimate calculation listeners
            const calcInputs = ['property-type', 'service-type', 'square-footage', 'bedrooms', 'bathrooms', 'kitchen', 'living-areas', 'frequency'];
            calcInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateEstimate);
                    element.addEventListener('change', calculateEstimate);
                }
            });

            // Initialize addon services
            loadAddonServices();
        }

        // Dashboard
        function updateDashboard() {
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            
            const monthlyEstimates = appData.estimates.filter(est => {
                const date = new Date(est.date);
                return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
            });

            const monthlyRevenue = monthlyEstimates.reduce((sum, est) => sum + (est.total || 0), 0);
            const acceptedEstimates = monthlyEstimates.filter(est => est.status === 'accepted');
            const conversionRate = monthlyEstimates.length > 0 ? Math.round((acceptedEstimates.length / monthlyEstimates.length) * 100) : 0;
            // Count unique clients from all quotes (by email)
            const uniqueClientEmails = new Set(
                appData.estimates
                    .filter(est => est.clientEmail)
                    .map(est => est.clientEmail.toLowerCase())
            );
            const activeClients = uniqueClientEmails.size;

            document.getElementById('stat-revenue').textContent = `$${monthlyRevenue.toLocaleString()}`;
            document.getElementById('stat-estimates').textContent = monthlyEstimates.length;
            document.getElementById('stat-conversion').textContent = `${conversionRate}%`;
            document.getElementById('stat-clients').textContent = activeClients;

            // Load recent estimates
            loadRecentEstimates();
        }

        // Helper function to safely format dates
        function formatDate(dateValue) {
            if (!dateValue) return '-';
            const date = new Date(dateValue);
            if (isNaN(date.getTime())) return '-';
            return date.toLocaleDateString();
        }
        
        // Helper function to safely format currency
        function formatCurrency(value) {
            const num = parseFloat(value);
            if (isNaN(num)) return '$0.00';
            return '$' + num.toFixed(2);
        }
        
        // Helper function to safely get string value
        function safeString(value, fallback = '-') {
            if (value === null || value === undefined || value === '') return fallback;
            return String(value);
        }

        function loadRecentEstimates() {
            const recentContainer = document.getElementById('recent-estimates');
            const estimates = appData.estimates.slice(-5).reverse();

            if (estimates.length === 0) {
                recentContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üßÆ</div>
                        <h3>No estimates yet</h3>
                        <p>Create your first estimate to track your progress.</p>
                        <button class="btn btn-primary" onclick="showView('estimates')">Create Estimate</button>
                    </div>
                `;
                return;
            }

            let html = '<div class="table-wrapper"><table class="table"><thead><tr><th>Client</th><th>Amount</th><th>Status</th><th>Date</th></tr></thead><tbody>';
            
            estimates.forEach(estimate => {
                const status = estimate.status || 'pending';
                const statusClass = status === 'accepted' ? 'text-green-600' : status === 'declined' ? 'text-red-600' : 'text-yellow-600';
                const dateField = estimate.createdAt || estimate.date;
                const clientName = safeString(estimate.clientName, 'Unknown Client');
                const amount = formatCurrency(estimate.total || estimate.amount || 0);
                const dateStr = formatDate(dateField);
                
                html += `
                    <tr>
                        <td>${clientName}</td>
                        <td>${amount}</td>
                        <td><span class="${statusClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span></td>
                        <td>${dateStr}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            recentContainer.innerHTML = html;
        }

        // Estimate Calculator
        function initializeEstimateForm() {
            loadAddonServices();
            calculateEstimate();
        }

        function setPricingMethod(method) {
            currentPricingMethod = method;
            
            // Update button states
            document.getElementById('pricing-sqft').className = method === 'sqft' ? 'btn btn-primary' : 'btn btn-outline';
            document.getElementById('pricing-rooms').className = method === 'rooms' ? 'btn btn-primary' : 'btn btn-outline';
            
            // Show/hide appropriate sections
            document.getElementById('sqft-method').classList.toggle('hidden', method !== 'sqft');
            document.getElementById('rooms-method').classList.toggle('hidden', method !== 'rooms');
            
            calculateEstimate();
        }

        function loadAddonServices() {
            const container = document.getElementById('addon-services');
            let html = '';
            
            appData.settings.addons.forEach((addon, index) => {
                html += `
                    <div class="addon-item">
                        <input type="checkbox" id="addon-${index}" data-price="${addon.price}" onchange="calculateEstimate()">
                        <label for="addon-${index}" class="addon-label">${addon.name}</label>
                        <div class="addon-price">+$${addon.price}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function calculateEstimate() {
            const propertyType = document.getElementById('property-type').value;
            const serviceType = document.getElementById('service-type').value;
            const frequency = document.getElementById('frequency').value;
            
            let basePrice = 0;
            
            // Calculate base price
            if (currentPricingMethod === 'sqft') {
                const sqft = parseInt(document.getElementById('square-footage').value) || 0;
                const rates = appData.settings.pricing.sqft[propertyType];
                if (rates && rates[serviceType]) {
                    basePrice = sqft * rates[serviceType];
                }
            } else {
                const bedrooms = parseInt(document.getElementById('bedrooms').value) || 0;
                const bathrooms = parseFloat(document.getElementById('bathrooms').value) || 0;
                const kitchen = parseInt(document.getElementById('kitchen').value) || 0;
                const livingAreas = parseInt(document.getElementById('living-areas').value) || 0;
                
                const rates = appData.settings.pricing.rooms;
                basePrice = (bedrooms * rates.bedroom) + (bathrooms * rates.bathroom) + 
                           (kitchen * rates.kitchen) + (livingAreas * rates.living);
            }
            
            // Calculate addons
            let addonTotal = 0;
            document.querySelectorAll('#addon-services input:checked').forEach(checkbox => {
                addonTotal += parseFloat(checkbox.dataset.price) || 0;
            });
            
            // Calculate subtotal
            let subtotal = basePrice + addonTotal;
            
            // Apply frequency discount
            let discountAmount = 0;
            const discounts = appData.settings.pricing.discounts;
            if (frequency === 'weekly') discountAmount = subtotal * (discounts.weekly / 100);
            else if (frequency === 'biweekly') discountAmount = subtotal * (discounts.biweekly / 100);
            else if (frequency === 'monthly') discountAmount = subtotal * (discounts.monthly / 100);
            
            subtotal -= discountAmount;
            
            // Calculate tax
            const taxAmount = subtotal * (appData.settings.pricing.tax / 100);
            const total = subtotal + taxAmount;
            
            // Update display
            document.getElementById('base-price').textContent = `$${basePrice.toFixed(2)}`;
            document.getElementById('addon-total').textContent = `$${addonTotal.toFixed(2)}`;
            document.getElementById('discount-amount').textContent = `-$${discountAmount.toFixed(2)}`;
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('tax-amount').textContent = `$${taxAmount.toFixed(2)}`;
            document.getElementById('total-amount').textContent = `$${total.toFixed(2)}`;
        }

        function clearEstimate() {
            document.getElementById('estimate-form').reset();
            document.getElementById('start-date').valueAsDate = new Date();
            document.querySelectorAll('#addon-services input').forEach(checkbox => {
                checkbox.checked = false;
            });
            calculateEstimate();
        }

        async function handleEstimateSubmit(e) {
            e.preventDefault();
            await generateProposal();
        }

        async function saveEstimate() {
            const quoteData = {
                clientName: document.getElementById('client-name').value,
                propertyAddress: document.getElementById('property-address').value,
                propertyType: document.getElementById('property-type').value,
                serviceType: document.getElementById('service-type').value,
                pricingMethod: currentPricingMethod,
                total: parseFloat(document.getElementById('total-amount').textContent.replace('$', '').replace(',', '')),
                basePrice: parseFloat(document.getElementById('base-price').textContent.replace('$', '')),
                addonTotal: parseFloat(document.getElementById('addon-total').textContent.replace('$', '')),
                discountAmount: parseFloat(document.getElementById('discount-amount').textContent.replace('-$', '')),
                taxAmount: parseFloat(document.getElementById('tax-amount').textContent.replace('$', '')),
                frequency: document.getElementById('frequency').value,
                notes: document.getElementById('special-notes').value,
                status: 'draft'
            };
            
            const quote = await createQuoteAPI(quoteData);
            if (quote) {
                appData.estimates.push(quote);
                showToast('Estimate saved as draft');
            }
        }

        async function generateProposal() {
            const quoteData = {
                clientName: document.getElementById('client-name').value,
                propertyAddress: document.getElementById('property-address').value,
                propertyType: document.getElementById('property-type').value,
                serviceType: document.getElementById('service-type').value,
                frequency: document.getElementById('frequency').value,
                total: parseFloat(document.getElementById('total-amount').textContent.replace('$', '').replace(',', '')),
                basePrice: parseFloat(document.getElementById('base-price').textContent.replace('$', '')),
                addonTotal: parseFloat(document.getElementById('addon-total').textContent.replace('$', '')),
                discountAmount: parseFloat(document.getElementById('discount-amount').textContent.replace('-$', '')),
                taxAmount: parseFloat(document.getElementById('tax-amount').textContent.replace('$', '')),
                notes: document.getElementById('special-notes').value,
                status: 'pending'
            };
            
            const quote = await createQuoteAPI(quoteData);
            if (quote) {
                appData.estimates.push(quote);
                displayProposal(quote);
                showView('proposals');
                showToast('Proposal generated successfully!');
            }
        }

        // Analytics
        let statusChart = null;
        let trendChart = null;
        let revenueChart = null;

        async function loadAnalytics() {
            const upgradePrompt = document.getElementById('analytics-upgrade-prompt');
            const dashboard = document.getElementById('analytics-dashboard');
            
            // Check if user is Pro
            if (cqUser.subscriptionStatus !== 'active') {
                upgradePrompt.style.display = 'block';
                dashboard.style.display = 'none';
                return;
            }
            
            upgradePrompt.style.display = 'none';
            dashboard.style.display = 'block';
            
            try {
                const response = await fetch(`${API_URL}/analytics`, {
                    headers: {
                        'Authorization': `Bearer ${cqToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 403) {
                        upgradePrompt.style.display = 'block';
                        dashboard.style.display = 'none';
                        return;
                    }
                    throw new Error('Failed to load analytics');
                }
                
                const data = await response.json();
                renderAnalytics(data);
            } catch (err) {
                console.error('Analytics error:', err);
                showToast('Failed to load analytics', 'error');
            }
        }

        function renderAnalytics(data) {
            // Update summary stats
            document.getElementById('stat-total-quotes').textContent = data.summary.totalQuotes;
            document.getElementById('stat-this-month').textContent = data.summary.thisMonthQuotes;
            document.getElementById('stat-this-week').textContent = data.summary.thisWeekQuotes;
            document.getElementById('stat-conversion').textContent = data.summary.conversionRate + '%';
            
            // Update revenue stats
            document.getElementById('stat-total-quoted').textContent = '$' + formatNumber(data.summary.totalQuotedValue);
            document.getElementById('stat-accepted-value').textContent = '$' + formatNumber(data.summary.acceptedValue);
            document.getElementById('stat-avg-quote').textContent = '$' + formatNumber(data.summary.avgQuoteValue);
            
            // Render charts
            renderStatusChart(data.statusBreakdown);
            renderTrendChart(data.monthlyTrend);
            renderRevenueChart(data.monthlyTrend);
        }

        function formatNumber(num) {
            return parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function renderStatusChart(statusData) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (statusChart) {
                statusChart.destroy();
            }
            
            const labels = ['Draft', 'Sent', 'Accepted', 'Declined', 'Pending'];
            const values = [
                statusData.draft || 0,
                statusData.sent || 0,
                statusData.accepted || 0,
                statusData.declined || 0,
                statusData.pending || 0
            ];
            
            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#9ca3af', // Draft - gray
                            '#3b82f6', // Sent - blue
                            '#10b981', // Accepted - green
                            '#ef4444', // Declined - red
                            '#f59e0b'  // Pending - yellow
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function renderTrendChart(monthlyData) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            const labels = monthlyData.map(m => m.month);
            const totalQuotes = monthlyData.map(m => m.totalQuotes);
            const acceptedQuotes = monthlyData.map(m => m.acceptedQuotes);
            
            trendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Quotes',
                            data: totalQuotes,
                            backgroundColor: '#3b82f6',
                            borderRadius: 4
                        },
                        {
                            label: 'Accepted',
                            data: acceptedQuotes,
                            backgroundColor: '#10b981',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function renderRevenueChart(monthlyData) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            const labels = monthlyData.map(m => m.month);
            const revenue = monthlyData.map(m => m.revenue);
            
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue',
                        data: revenue,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#10b981',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Proposals
        function loadProposals() {
            const container = document.getElementById('proposals-list');
            const proposals = [...appData.estimates]; // Create a copy to avoid mutating original
            
            if (proposals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No proposals yet</h3>
                        <p>Create your first estimate to generate a proposal.</p>
                        <button class="btn btn-primary" onclick="showView('estimates')">Create Estimate</button>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-wrapper"><table class="table"><thead><tr><th>Client</th><th>Property</th><th>Amount</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
            
            proposals.reverse().forEach(proposal => {
                const proposalId = proposal._id || proposal.id;
                const status = proposal.status || 'pending';
                const statusClass = status === 'accepted' ? 'text-green-600' : status === 'declined' ? 'text-red-600' : 'text-yellow-600';
                const dateField = proposal.createdAt || proposal.date;
                const clientName = safeString(proposal.clientName, 'Unknown Client');
                const propertyAddress = safeString(proposal.propertyAddress, 'No address');
                const amount = formatCurrency(proposal.total || proposal.amount || 0);
                const dateStr = formatDate(dateField);
                
                const clientEmail = proposal.clientEmail || '';
                const canSend = clientEmail && status !== 'sent' && status !== 'accepted';
                const sentAt = proposal.sentAt ? formatDate(proposal.sentAt) : null;
                const statusDisplay = sentAt ? `Sent ${sentAt}` : status.charAt(0).toUpperCase() + status.slice(1);
                
                html += `
                    <tr>
                        <td>${clientName}</td>
                        <td>${propertyAddress}</td>
                        <td>${amount}</td>
                        <td>${dateStr}</td>
                        <td><span class="${statusClass}">${statusDisplay}</span></td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline" onclick="viewProposal('${proposalId}')">View</button>
                                <button class="btn btn-sm btn-secondary" onclick="shareProposal('${proposalId}')">üîó Share</button>
                                ${canSend ? `<button class="btn btn-sm btn-primary" onclick="sendQuoteEmail('${proposalId}')">üìß Send</button>` : ''}
                                <button class="btn btn-sm btn-secondary" onclick="scheduleQuote('${proposalId}')">üìÖ</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProposal('${proposalId}')">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function displayProposal(estimate) {
            // Show proposal preview
            document.getElementById('proposal-preview').classList.remove('hidden');
            
            // Apply branding
            const branding = cqUser.branding || currentBranding || {};
            const proposalHeader = document.getElementById('proposal-header-styled');
            const proposalLogo = document.getElementById('proposal-logo');
            
            // Apply brand color to header
            if (branding.brandColor) {
                proposalHeader.style.background = branding.brandColor;
            }
            
            // Show logo if available
            if (branding.logoData) {
                proposalLogo.src = branding.logoData;
                proposalLogo.style.display = 'block';
            } else {
                proposalLogo.style.display = 'none';
            }
            
            // Fill in proposal data
            const dateField = estimate.createdAt || estimate.date;
            const companyName = branding.companyDisplayName || appData.settings.company.name;
            document.getElementById('proposal-company-name').textContent = companyName;
            document.getElementById('proposal-company-contact').textContent = 
                `${appData.settings.company.phone} ‚Ä¢ ${appData.settings.company.email} ‚Ä¢ ${appData.settings.company.address}`;
            document.getElementById('proposal-client-name').textContent = estimate.clientName;
            document.getElementById('proposal-property-address').textContent = estimate.propertyAddress;
            document.getElementById('proposal-date').textContent = new Date(dateField).toLocaleDateString();
            document.getElementById('proposal-total').textContent = `$${(estimate.total || 0).toFixed(2)}`;
            
            // Fill services table
            const servicesTable = document.getElementById('proposal-services');
            let html = `
                <tr>
                    <td>${estimate.serviceType.charAt(0).toUpperCase() + estimate.serviceType.slice(1)} Clean</td>
                    <td>${estimate.propertyType.charAt(0).toUpperCase() + estimate.propertyType.slice(1)} property</td>
                    <td>$${estimate.basePrice.toFixed(2)}</td>
                </tr>
            `;
            
            if (estimate.addonTotal > 0) {
                html += `
                    <tr>
                        <td>Add-on Services</td>
                        <td>Additionalmoving services</td>
                        <td>$${estimate.addonTotal.toFixed(2)}</td>
                    </tr>
                `;
            }
            
            if (estimate.discountAmount > 0) {
                html += `
                    <tr>
                        <td>Frequency Discount</td>
                        <td>${estimate.frequency} service discount</td>
                        <td>-$${estimate.discountAmount.toFixed(2)}</td>
                    </tr>
                `;
            }
            
            if (estimate.taxAmount > 0) {
                html += `
                    <tr>
                        <td>Tax</td>
                        <td>${appData.settings.pricing.tax}% sales tax</td>
                        <td>$${estimate.taxAmount.toFixed(2)}</td>
                    </tr>
                `;
            }
            
            servicesTable.innerHTML = html;
            
            // Fill terms
            document.getElementById('proposal-terms').innerHTML = 
                appData.settings.terms.split('\n').map(term => `<p>‚Ä¢ ${term}</p>`).join('');
        }

        function viewProposal(id) {
            const proposal = appData.estimates.find(p => p.id === id || p._id === id);
            if (proposal) {
                displayProposal(proposal);
            }
        }

        function editProposal(id) {
            // For now, redirect to estimates view
            const proposal = appData.estimates.find(p => p.id === id || p._id === id);
            showView('estimates');
            showToast('Load the proposal data into the estimate form to edit');
        }

        async function deleteProposal(id) {
            if (confirm('Are you sure you want to delete this proposal?')) {
                const deleted = await deleteQuoteAPI(id);
                if (deleted) {
                    appData.estimates = appData.estimates.filter(p => p.id !== id && p._id !== id);
                    loadProposals();
                    showToast('Proposal deleted');
                }
            }
        }

        function printProposal() {
            window.print();
        }

        // Send quote via email to client
        async function sendQuoteEmail(quoteId) {
            const proposal = appData.estimates.find(p => p.id === quoteId || p._id === quoteId);
            if (!proposal) {
                showToast('Quote not found', 'error');
                return;
            }
            
            if (!proposal.clientEmail) {
                showToast('Client email is required to send quote', 'error');
                return;
            }
            
            if (!confirm(`Send quote to ${proposal.clientEmail}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/quotes/${quoteId}/send`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${cqToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to send quote');
                }
                
                const data = await response.json();
                
                // Update local data with sent status
                const index = appData.estimates.findIndex(p => p.id === quoteId || p._id === quoteId);
                if (index !== -1) {
                    appData.estimates[index].status = 'sent';
                    appData.estimates[index].sentAt = new Date().toISOString();
                }
                
                loadProposals();
                showToast(`Quote sent to ${proposal.clientEmail}!`);
            } catch (err) {
                console.error('Send quote error:', err);
                showToast(err.message || 'Failed to send quote', 'error');
            }
        }

        // ============================================
        // CLIENTS API FUNCTIONS
        // ============================================
        
        let clientsData = [];
        
        async function loadClients() {
            const container = document.getElementById('clients-list');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const response = await fetch(`${API_URL}/api/clients`, {
                    headers: authHeaders()
                });
                
                if (!response.ok) throw new Error('Failed to load clients');
                
                const data = await response.json();
                clientsData = data.clients || [];
                renderClients();
            } catch (err) {
                console.error('Load clients error:', err);
                container.innerHTML = '<div class="empty-state"><p>Failed to load clients</p></div>';
            }
        }
        
        function renderClients() {
            const container = document.getElementById('clients-list');
            
            if (clientsData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <h3>No clients yet</h3>
                        <p>Add your first client to get started.</p>
                        <button class="btn btn-primary" onclick="showAddClientModal()">Add Client</button>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-wrapper"><table class="table"><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Address</th><th>Actions</th></tr></thead><tbody>';
            
            clientsData.forEach(client => {
                html += `
                    <tr>
                        <td>${safeString(client.name)}</td>
                        <td>${safeString(client.email, '-')}</td>
                        <td>${safeString(client.phone, '-')}</td>
                        <td>${safeString(client.address, '-')}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline" onclick="editClient('${client.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteClient('${client.id}')">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        function showAddClientModal() {
            const modal = createModal('Add Client', `
                <form id="client-form">
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" id="modal-client-name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="modal-client-email" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" id="modal-client-phone" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea id="modal-client-address" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea id="modal-client-notes" class="form-textarea"></textarea>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Save Client</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
            
            document.getElementById('client-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveClient();
            });
        }
        
        async function saveClient(clientId = null) {
            const clientData = {
                name: document.getElementById('modal-client-name').value,
                email: document.getElementById('modal-client-email').value,
                phone: document.getElementById('modal-client-phone').value,
                address: document.getElementById('modal-client-address').value,
                notes: document.getElementById('modal-client-notes').value
            };
            
            try {
                const url = clientId ? `${API_URL}/api/clients/${clientId}` : `${API_URL}/api/clients`;
                const method = clientId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: authHeaders(),
                    body: JSON.stringify(clientData)
                });
                
                if (!response.ok) throw new Error('Failed to save client');
                
                closeModal();
                loadClients();
                showToast(clientId ? 'Client updated!' : 'Client added!');
            } catch (err) {
                console.error('Save client error:', err);
                showToast('Failed to save client', 'error');
            }
        }
        
        async function editClient(clientId) {
            const client = clientsData.find(c => c.id === clientId);
            if (!client) return;
            
            const modal = createModal('Edit Client', `
                <form id="client-form">
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" id="modal-client-name" class="form-input" value="${client.name || ''}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="modal-client-email" class="form-input" value="${client.email || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" id="modal-client-phone" class="form-input" value="${client.phone || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea id="modal-client-address" class="form-textarea">${client.address || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea id="modal-client-notes" class="form-textarea">${client.notes || ''}</textarea>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Update Client</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
            
            document.getElementById('client-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveClient(clientId);
            });
        }
        
        async function deleteClient(clientId) {
            if (!confirm('Delete this client?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/clients/${clientId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                
                if (!response.ok) throw new Error('Failed to delete client');
                
                loadClients();
                showToast('Client deleted');
            } catch (err) {
                console.error('Delete client error:', err);
                showToast('Failed to delete client', 'error');
            }
        }
        
        // ============================================
        // SCHEDULE / CALENDAR API FUNCTIONS
        // ============================================
        
        let scheduleData = [];
        let currentCalendarMonth = new Date();
        
        async function loadSchedule() {
            renderCalendar();
            await loadScheduleData();
        }
        
        async function loadScheduleData() {
            const startOfMonth = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth(), 1);
            const endOfMonth = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() + 1, 0);
            
            const start = startOfMonth.toISOString().split('T')[0];
            const end = endOfMonth.toISOString().split('T')[0];
            
            try {
                const response = await fetch(`${API_URL}/api/schedule?start=${start}&end=${end}`, {
                    headers: authHeaders()
                });
                
                if (!response.ok) throw new Error('Failed to load schedule');
                
                const data = await response.json();
                scheduleData = data.jobs || [];
                renderCalendar();
                renderUpcomingJobs();
            } catch (err) {
                console.error('Load schedule error:', err);
            }
        }
        
        function renderCalendar() {
            const title = document.getElementById('calendar-month-title');
            const grid = document.getElementById('calendar-grid');
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            title.textContent = `${monthNames[currentCalendarMonth.getMonth()]} ${currentCalendarMonth.getFullYear()}`;
            
            const firstDay = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth(), 1);
            const lastDay = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();
            
            let html = '';
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Empty cells before first day
            for (let i = 0; i < startDayOfWeek; i++) {
                html += '<div class="calendar-day" style="background: #f9fafb;"></div>';
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentCalendarMonth.getFullYear()}-${String(currentCalendarMonth.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayJobs = scheduleData.filter(job => job.scheduledDate && job.scheduledDate.startsWith(dateStr));
                
                let eventsHtml = '';
                dayJobs.slice(0, 3).forEach(job => {
                    const statusColor = job.status === 'completed' ? '#10b981' : job.status === 'cancelled' ? '#ef4444' : '#3b82f6';
                    eventsHtml += `<div class="calendar-event" style="background: ${statusColor}20; color: ${statusColor}; border-left: 2px solid ${statusColor};" onclick="viewJobDetails('${job.id}')">${safeString(job.clientName, 'Job')}</div>`;
                });
                if (dayJobs.length > 3) {
                    eventsHtml += `<div style="font-size: 0.7rem; color: #6b7280;">+${dayJobs.length - 3} more</div>`;
                }
                
                const isToday = new Date().toISOString().split('T')[0] === dateStr;
                html += `<div class="calendar-day" ${isToday ? 'style="background: #d1fae5;"' : ''}>
                    <div class="calendar-day-number">${day}</div>
                    ${eventsHtml}
                </div>`;
            }
            
            grid.innerHTML = html;
        }
        
        function navigateCalendar(direction) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + direction);
            loadScheduleData();
        }
        
        function renderUpcomingJobs() {
            const container = document.getElementById('upcoming-jobs-list');
            
            const upcoming = scheduleData
                .filter(job => job.scheduledDate && new Date(job.scheduledDate) >= new Date())
                .sort((a, b) => new Date(a.scheduledDate) - new Date(b.scheduledDate))
                .slice(0, 10);
            
            if (upcoming.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No upcoming jobs scheduled</p></div>';
                return;
            }
            
            let html = '<div class="table-wrapper"><table class="table"><thead><tr><th>Date</th><th>Client</th><th>Address</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
            
            upcoming.forEach(job => {
                const statusColors = { scheduled: '#3b82f6', completed: '#10b981', cancelled: '#ef4444' };
                html += `
                    <tr>
                        <td>${formatDate(job.scheduledDate)}${job.scheduledTime ? ' ' + job.scheduledTime : ''}</td>
                        <td>${safeString(job.clientName)}</td>
                        <td>${safeString(job.propertyAddress, '-')}</td>
                        <td><span style="color: ${statusColors[job.status] || '#6b7280'}">${job.status || 'scheduled'}</span></td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline" onclick="markJobComplete('${job.id}')">‚úì Complete</button>
                                <button class="btn btn-sm btn-secondary" onclick="viewJobDetails('${job.id}')">View</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        async function markJobComplete(jobId) {
            try {
                const response = await fetch(`${API_URL}/api/schedule/${jobId}/status`, {
                    method: 'PUT',
                    headers: authHeaders(),
                    body: JSON.stringify({ status: 'completed' })
                });
                
                if (!response.ok) throw new Error('Failed to update job');
                
                loadScheduleData();
                showToast('Job marked as complete!');
            } catch (err) {
                console.error('Update job error:', err);
                showToast('Failed to update job', 'error');
            }
        }
        
        function viewJobDetails(jobId) {
            const job = scheduleData.find(j => j.id === jobId) || appData.estimates.find(e => e.id === jobId);
            if (!job) return;
            
            createModal('Job Details', `
                <div style="margin-bottom: 1rem;">
                    <p><strong>Client:</strong> ${safeString(job.clientName)}</p>
                    <p><strong>Address:</strong> ${safeString(job.propertyAddress, '-')}</p>
                    <p><strong>Scheduled:</strong> ${formatDate(job.scheduledDate)} ${job.scheduledTime || ''}</p>
                    <p><strong>Status:</strong> ${job.status || 'scheduled'}</p>
                    <p><strong>Total:</strong> ${formatCurrency(job.totalPrice || job.total)}</p>
                    ${job.assignedToName ? `<p><strong>Assigned To:</strong> ${job.assignedToName}</p>` : ''}
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="viewProposal('${job.id}'); closeModal();">View Quote</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                </div>
            `);
        }
        
        // ============================================
        // CHECKLISTS API FUNCTIONS
        // ============================================
        
        let checklistsData = [];
        
        async function loadChecklists() {
            const container = document.getElementById('checklists-list');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const response = await fetch(`${API_URL}/api/checklists`, {
                    headers: authHeaders()
                });
                
                if (!response.ok) throw new Error('Failed to load checklists');
                
                const data = await response.json();
                checklistsData = data.checklists || [];
                renderChecklists();
            } catch (err) {
                console.error('Load checklists error:', err);
                container.innerHTML = '<div class="empty-state"><p>Failed to load checklists</p></div>';
            }
        }
        
        function renderChecklists() {
            const container = document.getElementById('checklists-list');
            
            if (checklistsData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <h3>No checklist templates</h3>
                        <p>Create a checklist template to standardize yourmoving tasks.</p>
                        <button class="btn btn-primary" onclick="showAddChecklistModal()">Create Template</button>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; gap: 1rem;">';
            
            checklistsData.forEach(checklist => {
                const rooms = checklist.rooms || [];
                const totalTasks = rooms.reduce((sum, r) => sum + (r.tasks?.length || 0), 0);
                
                html += `
                    <div class="card" style="margin-bottom: 0; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h3 style="margin: 0 0 0.5rem 0;">${safeString(checklist.name)}</h3>
                                <p style="color: #6b7280; margin: 0;">${rooms.length} rooms, ${totalTasks} tasks</p>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline" onclick="editChecklist('${checklist.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteChecklist('${checklist.id}')">Delete</button>
                            </div>
                        </div>
                        ${rooms.length > 0 ? `<div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">${rooms.map(r => `<span style="background: #e5e7eb; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${r.room}</span>`).join('')}</div>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function showAddChecklistModal() {
            createModal('Create Checklist Template', `
                <form id="checklist-form">
                    <div class="form-group">
                        <label class="form-label">Template Name *</label>
                        <input type="text" id="modal-checklist-name" class="form-input" placeholder="e.g., Deep Clean Checklist" required>
                    </div>
                    <div id="rooms-container">
                        <label class="form-label">Rooms & Tasks</label>
                        <div id="rooms-list"></div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addRoomToChecklist()">+ Add Room</button>
                    </div>
                    <div class="btn-group mt-3">
                        <button type="submit" class="btn btn-primary">Save Template</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
            
            addRoomToChecklist(); // Add first room
            
            document.getElementById('checklist-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveChecklist();
            });
        }
        
        let roomCounter = 0;
        function addRoomToChecklist() {
            const container = document.getElementById('rooms-list');
            const roomId = roomCounter++;
            
            const roomHtml = `
                <div id="room-${roomId}" style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <input type="text" class="form-input room-name" placeholder="Room name (e.g., Kitchen)" style="flex: 1;">
                        <button type="button" class="btn btn-danger btn-sm" onclick="document.getElementById('room-${roomId}').remove()">‚úï</button>
                    </div>
                    <div class="tasks-list" style="margin-left: 1rem;"></div>
                    <button type="button" class="btn btn-outline btn-sm" onclick="addTaskToRoom(${roomId})">+ Add Task</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', roomHtml);
            addTaskToRoom(roomId);
        }
        
        function addTaskToRoom(roomId) {
            const tasksContainer = document.querySelector(`#room-${roomId} .tasks-list`);
            const taskHtml = `
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="text" class="form-input task-input" placeholder="Task (e.g., Clean sink)" style="flex: 1;">
                    <button type="button" class="btn btn-outline btn-sm" onclick="this.parentElement.remove()">‚úï</button>
                </div>
            `;
            tasksContainer.insertAdjacentHTML('beforeend', taskHtml);
        }
        
        async function saveChecklist(checklistId = null) {
            const name = document.getElementById('modal-checklist-name').value;
            
            const rooms = [];
            document.querySelectorAll('#rooms-list > div').forEach(roomEl => {
                const roomName = roomEl.querySelector('.room-name').value;
                if (!roomName.trim()) return;
                
                const tasks = [];
                roomEl.querySelectorAll('.task-input').forEach(taskInput => {
                    if (taskInput.value.trim()) {
                        tasks.push(taskInput.value.trim());
                    }
                });
                
                rooms.push({ room: roomName.trim(), tasks });
            });
            
            try {
                const url = checklistId ? `${API_URL}/api/checklists/${checklistId}` : `${API_URL}/api/checklists`;
                const method = checklistId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: authHeaders(),
                    body: JSON.stringify({ name, rooms })
                });
                
                if (!response.ok) throw new Error('Failed to save checklist');
                
                closeModal();
                loadChecklists();
                showToast('Checklist saved!');
            } catch (err) {
                console.error('Save checklist error:', err);
                showToast('Failed to save checklist', 'error');
            }
        }
        
        async function editChecklist(checklistId) {
            const checklist = checklistsData.find(c => c.id === checklistId);
            if (!checklist) return;
            
            createModal('Edit Checklist Template', `
                <form id="checklist-form">
                    <div class="form-group">
                        <label class="form-label">Template Name *</label>
                        <input type="text" id="modal-checklist-name" class="form-input" value="${checklist.name}" required>
                    </div>
                    <div id="rooms-container">
                        <label class="form-label">Rooms & Tasks</label>
                        <div id="rooms-list"></div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addRoomToChecklist()">+ Add Room</button>
                    </div>
                    <div class="btn-group mt-3">
                        <button type="submit" class="btn btn-primary">Update Template</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
            
            // Populate existing rooms
            roomCounter = 0;
            const rooms = checklist.rooms || [];
            rooms.forEach(room => {
                const container = document.getElementById('rooms-list');
                const roomId = roomCounter++;
                
                const roomHtml = `
                    <div id="room-${roomId}" style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" class="form-input room-name" value="${room.room}" style="flex: 1;">
                            <button type="button" class="btn btn-danger btn-sm" onclick="document.getElementById('room-${roomId}').remove()">‚úï</button>
                        </div>
                        <div class="tasks-list" style="margin-left: 1rem;"></div>
                        <button type="button" class="btn btn-outline btn-sm" onclick="addTaskToRoom(${roomId})">+ Add Task</button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', roomHtml);
                
                // Add tasks
                const tasksContainer = document.querySelector(`#room-${roomId} .tasks-list`);
                (room.tasks || []).forEach(task => {
                    const taskHtml = `
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" class="form-input task-input" value="${task}" style="flex: 1;">
                            <button type="button" class="btn btn-outline btn-sm" onclick="this.parentElement.remove()">‚úï</button>
                        </div>
                    `;
                    tasksContainer.insertAdjacentHTML('beforeend', taskHtml);
                });
            });
            
            if (rooms.length === 0) addRoomToChecklist();
            
            document.getElementById('checklist-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveChecklist(checklistId);
            });
        }
        
        async function deleteChecklist(checklistId) {
            if (!confirm('Delete this checklist template?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/checklists/${checklistId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                
                if (!response.ok) throw new Error('Failed to delete checklist');
                
                loadChecklists();
                showToast('Checklist deleted');
            } catch (err) {
                console.error('Delete checklist error:', err);
                showToast('Failed to delete checklist', 'error');
            }
        }
        
        // ============================================
        // TEAM API FUNCTIONS (Pro)
        // ============================================
        
        let teamData = [];
        
        async function loadTeam() {
            const upgradePrompt = document.getElementById('team-upgrade-prompt');
            const teamList = document.getElementById('team-list');
            
            // Check if user is Pro
            if (cqUser.subscriptionStatus !== 'active') {
                upgradePrompt.style.display = 'block';
                teamList.style.display = 'none';
                return;
            }
            
            upgradePrompt.style.display = 'none';
            teamList.style.display = 'block';
            teamList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const response = await fetch(`${API_URL}/api/team`, {
                    headers: authHeaders()
                });
                
                if (response.status === 403) {
                    upgradePrompt.style.display = 'block';
                    teamList.style.display = 'none';
                    return;
                }
                
                if (!response.ok) throw new Error('Failed to load team');
                
                const data = await response.json();
                teamData = data.team || [];
                renderTeam();
            } catch (err) {
                console.error('Load team error:', err);
                teamList.innerHTML = '<div class="empty-state"><p>Failed to load team</p></div>';
            }
        }
        
        function renderTeam() {
            const container = document.getElementById('team-list');
            
            if (teamData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë∑</div>
                        <h3>No team members yet</h3>
                        <p>Add your first team member to start assigning jobs.</p>
                        <button class="btn btn-primary" onclick="showAddTeamMemberModal()">Add Team Member</button>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-wrapper"><table class="table"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead><tbody>';
            
            teamData.forEach(member => {
                html += `
                    <tr>
                        <td>${safeString(member.name)}</td>
                        <td>${safeString(member.email, '-')}</td>
                        <td>${safeString(member.role, 'cleaner')}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline" onclick="viewTeamMemberJobs('${member.id}')">View Jobs</button>
                                <button class="btn btn-sm btn-secondary" onclick="editTeamMember('${member.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTeamMember('${member.id}')">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        function showAddTeamMemberModal() {
            if (cqUser.subscriptionStatus !== 'active') {
                showUpgradeModal('Team management is a Pro feature. Upgrade to add team members.');
                return;
            }
            
            createModal('Add Team Member', `
                <form id="team-form">
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" id="modal-team-name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="modal-team-email" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select id="modal-team-role" class="form-select">
                            <option value="cleaner">Cleaner</option>
                            <option value="supervisor">Supervisor</option>
                            <option value="manager">Manager</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Add Member</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
            
            document.getElementById('team-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveTeamMember();
            });
        }
        
        async function saveTeamMember(memberId = null) {
            const memberData = {
                name: document.getElementById('modal-team-name').value,
                email: document.getElementById('modal-team-email').value,
                role: document.getElementById('modal-team-role').value
            };
            
            try {
                const url = memberId ? `${API_URL}/api/team/${memberId}` : `${API_URL}/api/team`;
                const method = memberId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: authHeaders(),
                    body: JSON.stringify(memberData)
                });
                
                if (!response.ok) throw new Error('Failed to save team member');
                
                closeModal();
                loadTeam();
                showToast(memberId ? 'Team member updated!' : 'Team member added!');
            } catch (err) {
                console.error('Save team member error:', err);
                showToast('Failed to save team member', 'error');
            }
        }
        
        async function editTeamMember(memberId) {
            const member = teamData.find(m => m.id === memberId);
            if (!member) return;
            
            createModal('Edit Team Member', `
                <form id="team-form">
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" id="modal-team-name" class="form-input" value="${member.name}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="modal-team-email" class="form-input" value="${member.email || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select id="modal-team-role" class="form-select">
                            <option value="cleaner" ${member.role === 'cleaner' ? 'selected' : ''}>Cleaner</option>
                            <option value="supervisor" ${member.role === 'supervisor' ? 'selected' : ''}>Supervisor</option>
                            <option value="manager" ${member.role === 'manager' ? 'selected' : ''}>Manager</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Update Member</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
            
            document.getElementById('team-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveTeamMember(memberId);
            });
        }
        
        async function deleteTeamMember(memberId) {
            if (!confirm('Delete this team member?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/team/${memberId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                
                if (!response.ok) throw new Error('Failed to delete team member');
                
                loadTeam();
                showToast('Team member removed');
            } catch (err) {
                console.error('Delete team member error:', err);
                showToast('Failed to delete team member', 'error');
            }
        }
        
        async function viewTeamMemberJobs(memberId) {
            try {
                const response = await fetch(`${API_URL}/api/team/${memberId}/jobs`, {
                    headers: authHeaders()
                });
                
                if (!response.ok) throw new Error('Failed to load jobs');
                
                const data = await response.json();
                const jobs = data.jobs || [];
                const member = teamData.find(m => m.id === memberId);
                
                let jobsHtml = jobs.length === 0 
                    ? '<p>No jobs assigned</p>'
                    : jobs.map(job => `<p>‚Ä¢ ${formatDate(job.scheduled_date)} - ${safeString(job.client_name)} (${job.status})</p>`).join('');
                
                createModal(`${member?.name}'s Jobs`, `
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${jobsHtml}
                    </div>
                    <div class="btn-group mt-3">
                        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                    </div>
                `);
            } catch (err) {
                console.error('Load team jobs error:', err);
                showToast('Failed to load jobs', 'error');
            }
        }
        
        // ============================================
        // SHAREABLE QUOTE LINK FUNCTIONS
        // ============================================
        
        async function getShareLink(quoteId) {
            try {
                const response = await fetch(`${API_URL}/api/quotes/${quoteId}/share`, {
                    headers: authHeaders()
                });
                
                if (!response.ok) throw new Error('Failed to get share link');
                
                const data = await response.json();
                return data.shareUrl;
            } catch (err) {
                console.error('Get share link error:', err);
                return null;
            }
        }
        
        async function shareProposal(quoteId) {
            const shareUrl = await getShareLink(quoteId);
            if (!shareUrl) {
                showToast('Failed to generate share link', 'error');
                return;
            }
            
            createModal('Share Proposal', `
                <p>Share this link with your client:</p>
                <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; word-break: break-all; font-family: monospace; font-size: 0.9rem;">
                    ${shareUrl}
                </div>
                <div class="btn-group mt-3">
                    <button class="btn btn-primary" onclick="navigator.clipboard.writeText('${shareUrl}'); showToast('Link copied!');">Copy Link</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                </div>
            `);
        }
        
        // ============================================
        // SCHEDULE A QUOTE FUNCTION
        // ============================================
        
        async function scheduleQuote(quoteId) {
            const quote = appData.estimates.find(q => q.id === quoteId || q._id === quoteId);
            
            // Load team members for assignment dropdown
            let teamOptions = '<option value="">Not Assigned</option>';
            if (cqUser.subscriptionStatus === 'active') {
                try {
                    const response = await fetch(`${API_URL}/api/team`, { headers: authHeaders() });
                    if (response.ok) {
                        const data = await response.json();
                        (data.team || []).forEach(member => {
                            const selected = quote?.assignedTo === member.id ? 'selected' : '';
                            teamOptions += `<option value="${member.id}" ${selected}>${member.name}</option>`;
                        });
                    }
                } catch (err) { console.error(err); }
            }
            
            createModal('Schedule Job', `
                <form id="schedule-form">
                    <div class="form-group">
                        <label class="form-label">Date *</label>
                        <input type="date" id="modal-schedule-date" class="form-input" value="${quote?.scheduledDate?.split('T')[0] || ''}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" id="modal-schedule-time" class="form-input" value="${quote?.scheduledTime || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Recurring</label>
                        <select id="modal-schedule-recurring" class="form-select">
                            <option value="none" ${quote?.recurring === 'none' ? 'selected' : ''}>One-time</option>
                            <option value="weekly" ${quote?.recurring === 'weekly' ? 'selected' : ''}>Weekly</option>
                            <option value="biweekly" ${quote?.recurring === 'biweekly' ? 'selected' : ''}>Bi-weekly</option>
                            <option value="monthly" ${quote?.recurring === 'monthly' ? 'selected' : ''}>Monthly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assign To</label>
                        <select id="modal-schedule-assigned" class="form-select">
                            ${teamOptions}
                        </select>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Schedule</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
            
            document.getElementById('schedule-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const scheduleData = {
                    scheduledDate: document.getElementById('modal-schedule-date').value,
                    scheduledTime: document.getElementById('modal-schedule-time').value,
                    recurring: document.getElementById('modal-schedule-recurring').value,
                    assignedTo: document.getElementById('modal-schedule-assigned').value || null
                };
                
                try {
                    const response = await fetch(`${API_URL}/api/schedule/${quoteId}`, {
                        method: 'POST',
                        headers: authHeaders(),
                        body: JSON.stringify(scheduleData)
                    });
                    
                    if (!response.ok) throw new Error('Failed to schedule');
                    
                    closeModal();
                    loadProposals();
                    showToast('Job scheduled!');
                } catch (err) {
                    console.error('Schedule error:', err);
                    showToast('Failed to schedule job', 'error');
                }
            });
        }
        
        // ============================================
        // MODAL HELPER FUNCTIONS
        // ============================================
        
        function createModal(title, content) {
            closeModal(); // Close any existing modal
            
            const modal = document.createElement('div');
            modal.id = 'app-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 1rem;">
                    <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <h2 style="margin: 0 0 1.5rem 0; color: #111827;">${title}</h2>
                        ${content}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Close on backdrop click
            modal.querySelector('div').addEventListener('click', (e) => {
                if (e.target === modal.querySelector('div')) {
                    closeModal();
                }
            });
            
            return modal;
        }
        
        function closeModal() {
            const modal = document.getElementById('app-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Settings Management
        function loadSettings() {
            const settings = appData.settings;
            
            // Load company info
            document.getElementById('company-name').value = settings.company.name;

            // Pre-fill company name from signup
            if (cqUser.companyName) {
                const companyInput = document.querySelector('#settings input[placeholder*="Company"]') || document.querySelector('input[value="Your Cleaning Company"]');
                if (companyInput && companyInput.value === 'Your Cleaning Company') {
                    companyInput.value = cqUser.companyName;
                }
            }
            document.getElementById('company-phone').value = settings.company.phone;
            document.getElementById('company-email').value = settings.company.email;
            document.getElementById('company-website').value = settings.company.website;
            document.getElementById('company-address').value = settings.company.address;
            
            // Load pricing
            document.getElementById('rate-residential-standard').value = settings.pricing.sqft.residential.standard;
            document.getElementById('rate-residential-deep').value = settings.pricing.sqft.residential.deep;
            document.getElementById('rate-commercial-standard').value = settings.pricing.sqft.commercial.standard;
            document.getElementById('rate-commercial-deep').value = settings.pricing.sqft.commercial.deep;
            
            document.getElementById('rate-bedroom').value = settings.pricing.rooms.bedroom;
            document.getElementById('rate-bathroom').value = settings.pricing.rooms.bathroom;
            document.getElementById('rate-kitchen').value = settings.pricing.rooms.kitchen;
            document.getElementById('rate-living').value = settings.pricing.rooms.living;
            
            document.getElementById('discount-weekly').value = settings.pricing.discounts.weekly;
            document.getElementById('discount-biweekly').value = settings.pricing.discounts.biweekly;
            document.getElementById('discount-monthly').value = settings.pricing.discounts.monthly;
            document.getElementById('tax-rate').value = settings.pricing.tax;
            
            // Load terms
            document.getElementById('terms-conditions').value = settings.terms;
            
            // Load addon services
            loadAddonServicesConfig();
            
            // Load branding settings
            loadBranding();
        }

        // Branding Management
        let currentBranding = {
            logoData: null,
            brandColor: '#10b981',
            companyDisplayName: ''
        };

        async function loadBranding() {
            const upgradePrompt = document.getElementById('branding-upgrade-prompt');
            const formContainer = document.getElementById('branding-form-container');
            
            // Check if user is Pro
            if (cqUser.subscriptionStatus !== 'active') {
                upgradePrompt.style.display = 'block';
                formContainer.style.display = 'none';
                return;
            }
            
            upgradePrompt.style.display = 'none';
            formContainer.style.display = 'block';
            
            try {
                const response = await fetch(`${API_URL}/branding`, {
                    headers: {
                        'Authorization': `Bearer ${cqToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentBranding = data.branding;
                    
                    // Update form
                    if (currentBranding.logoData) {
                        document.getElementById('logo-preview').src = currentBranding.logoData;
                        document.getElementById('logo-preview').style.display = 'block';
                        document.getElementById('logo-placeholder').style.display = 'none';
                        document.getElementById('remove-logo-btn').style.display = 'inline-flex';
                    }
                    
                    document.getElementById('brand-color').value = currentBranding.brandColor || '#10b981';
                    document.getElementById('brand-color-hex').value = currentBranding.brandColor || '#10b981';
                    document.getElementById('color-preview').style.background = currentBranding.brandColor || '#10b981';
                    document.getElementById('company-display-name').value = currentBranding.companyDisplayName || '';
                    
                    updateBrandingPreview();
                }
            } catch (err) {
                console.error('Load branding error:', err);
            }
        }

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (500KB limit)
            if (file.size > 500 * 1024) {
                showToast('Logo file is too large. Please use an image under 500KB.', 'error');
                return;
            }
            
            // Check file type
            if (!file.type.startsWith('image/')) {
                showToast('Please upload an image file.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentBranding.logoData = e.target.result;
                document.getElementById('logo-preview').src = e.target.result;
                document.getElementById('logo-preview').style.display = 'block';
                document.getElementById('logo-placeholder').style.display = 'none';
                document.getElementById('remove-logo-btn').style.display = 'inline-flex';
                updateBrandingPreview();
            };
            reader.readAsDataURL(file);
        }

        function removeLogo() {
            currentBranding.logoData = null;
            document.getElementById('logo-preview').style.display = 'none';
            document.getElementById('logo-placeholder').style.display = 'flex';
            document.getElementById('remove-logo-btn').style.display = 'none';
            document.getElementById('logo-upload').value = '';
            updateBrandingPreview();
        }

        function syncColorFromHex() {
            const hexInput = document.getElementById('brand-color-hex');
            const colorInput = document.getElementById('brand-color');
            const preview = document.getElementById('color-preview');
            
            // Validate hex color
            if (/^#[0-9A-Fa-f]{6}$/.test(hexInput.value)) {
                colorInput.value = hexInput.value;
                preview.style.background = hexInput.value;
                currentBranding.brandColor = hexInput.value;
                updateBrandingPreview();
            }
        }

        // Sync color picker to hex input
        document.addEventListener('DOMContentLoaded', function() {
            const colorInput = document.getElementById('brand-color');
            if (colorInput) {
                colorInput.addEventListener('input', function() {
                    document.getElementById('brand-color-hex').value = this.value;
                    document.getElementById('color-preview').style.background = this.value;
                    currentBranding.brandColor = this.value;
                    updateBrandingPreview();
                });
            }
        });

        function updateBrandingPreview() {
            const previewHeader = document.getElementById('preview-header');
            const previewLogo = document.getElementById('preview-logo');
            const previewName = document.getElementById('preview-company-name');
            
            // Update header background
            previewHeader.style.background = currentBranding.brandColor || '#10b981';
            
            // Update logo preview
            if (currentBranding.logoData) {
                previewLogo.innerHTML = `<img src="${currentBranding.logoData}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">`;
            } else {
                previewLogo.innerHTML = 'Logo';
                previewLogo.style.background = 'rgba(255,255,255,0.2)';
                previewLogo.style.color = 'rgba(255,255,255,0.8)';
            }
            
            // Update company name
            const displayName = document.getElementById('company-display-name').value || 
                               currentBranding.companyDisplayName || 
                               cqUser.businessName || 
                               'Your Company';
            previewName.textContent = displayName;
        }

        async function saveBranding() {
            if (cqUser.subscriptionStatus !== 'active') {
                showToast('Branding is a Pro feature', 'error');
                return;
            }
            
            const brandColor = document.getElementById('brand-color').value;
            const companyDisplayName = document.getElementById('company-display-name').value;
            
            try {
                const response = await fetch(`${API_URL}/branding`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${cqToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        logoData: currentBranding.logoData,
                        brandColor: brandColor,
                        companyDisplayName: companyDisplayName
                    })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to save branding');
                }
                
                const data = await response.json();
                currentBranding = data.branding;
                
                // Update cqUser branding
                cqUser.branding = currentBranding;
                localStorage.setItem('cq_user', JSON.stringify(cqUser));
                
                showToast('Branding saved successfully!');
            } catch (err) {
                console.error('Save branding error:', err);
                showToast(err.message || 'Failed to save branding', 'error');
            }
        }

        function loadAddonServicesConfig() {
            const container = document.getElementById('addon-services-config');
            let html = '';
            
            appData.settings.addons.forEach((addon, index) => {
                html += `
                    <div class="form-row" style="align-items: end;">
                        <div class="form-group">
                            <label class="form-label">Service Name</label>
                            <input type="text" class="form-input" value="${addon.name}" onchange="updateAddon(${index}, 'name', this.value)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Price ($)</label>
                            <input type="number" class="form-input" value="${addon.price}" onchange="updateAddon(${index}, 'price', this.value)">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-danger btn-sm" onclick="removeAddon(${index})">Remove</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateAddon(index, field, value) {
            if (field === 'price') value = parseFloat(value) || 0;
            appData.settings.addons[index][field] = value;
            saveData();
        }

        function removeAddon(index) {
            appData.settings.addons.splice(index, 1);
            saveData();
            loadAddonServicesConfig();
        }

        function addAddonService() {
            const name = prompt('Service name:');
            const price = parseFloat(prompt('Price:')) || 0;
            
            if (name) {
                appData.settings.addons.push({ name, price });
                saveData();
                loadAddonServicesConfig();
                loadAddonServices(); // Update estimate form too
            }
        }

        function saveSettings() {
            // Save company info
            appData.settings.company = {
                name: document.getElementById('company-name').value,
                phone: document.getElementById('company-phone').value,
                email: document.getElementById('company-email').value,
                website: document.getElementById('company-website').value,
                address: document.getElementById('company-address').value
            };
            
            // Save pricing
            appData.settings.pricing.sqft.residential.standard = parseFloat(document.getElementById('rate-residential-standard').value) || 0.10;
            appData.settings.pricing.sqft.residential.deep = parseFloat(document.getElementById('rate-residential-deep').value) || 0.15;
            appData.settings.pricing.sqft.commercial.standard = parseFloat(document.getElementById('rate-commercial-standard').value) || 0.08;
            appData.settings.pricing.sqft.commercial.deep = parseFloat(document.getElementById('rate-commercial-deep').value) || 0.12;
            
            appData.settings.pricing.rooms.bedroom = parseFloat(document.getElementById('rate-bedroom').value) || 25;
            appData.settings.pricing.rooms.bathroom = parseFloat(document.getElementById('rate-bathroom').value) || 35;
            appData.settings.pricing.rooms.kitchen = parseFloat(document.getElementById('rate-kitchen').value) || 50;
            appData.settings.pricing.rooms.living = parseFloat(document.getElementById('rate-living').value) || 30;
            
            appData.settings.pricing.discounts.weekly = parseFloat(document.getElementById('discount-weekly').value) || 15;
            appData.settings.pricing.discounts.biweekly = parseFloat(document.getElementById('discount-biweekly').value) || 10;
            appData.settings.pricing.discounts.monthly = parseFloat(document.getElementById('discount-monthly').value) || 5;
            appData.settings.pricing.tax = parseFloat(document.getElementById('tax-rate').value) || 8.25;
            
            // Save terms
            appData.settings.terms = document.getElementById('terms-conditions').value;
            
            saveData();
            showToast('Settings saved successfully!');
        }

        function resetSettings() {
            if (confirm('This will reset all settings to defaults. Are you sure?')) {
                // Reset to default settings
                appData.settings = {
                    company: { name: 'Your Cleaning Company', phone: '(555) 123-4567', email: 'info@yourcompany.com', address: '', website: '' },
                    pricing: {
                        sqft: { residential: { standard: 0.10, deep: 0.15 }, commercial: { standard: 0.08, deep: 0.12 }, airbnb: { standard: 0.12, deep: 0.18 }, moveout: 0.20 },
                        rooms: { bedroom: 25, bathroom: 35, kitchen: 50, living: 30 },
                        discounts: { weekly: 15, biweekly: 10, monthly: 5 },
                        tax: 8.25
                    },
                    addons: [
                        { name: 'Inside Fridge', price: 25 },
                        { name: 'Inside Oven', price: 25 },
                        { name: 'Interior Windows', price: 50 },
                        { name: 'Laundry Service', price: 30 }
                    ],
                    terms: 'Payment is due upon completion of services.\nClient must provide access to property at scheduled time.\nCancellations require 24-hour notice.\nWe are fully insured and bonded.'
                };
                saveData();
                loadSettings();
                showToast('Settings reset to defaults');
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `cleanlyquote-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!');
        }

        function importData() {
            document.getElementById('import-file').click();
        }

        function handleImport() {
            const file = document.getElementById('import-file').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    appData = { ...appData, ...importedData };
                    saveData();
                    showToast('Data imported successfully!');
                    loadSettings();
                } catch (error) {
                    showToast('Error importing data. Please check file format.', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Preview Proposal
        function previewProposal() {
            const estimate = {
                clientName: document.getElementById('client-name').value || 'Sample Client',
                propertyAddress: document.getElementById('property-address').value || 'Sample Address',
                propertyType: document.getElementById('property-type').value || 'residential',
                serviceType: document.getElementById('service-type').value || 'standard',
                frequency: document.getElementById('frequency').value || 'one-time',
                total: parseFloat(document.getElementById('total-amount').textContent.replace('$', '').replace(',', '')) || 0,
                basePrice: parseFloat(document.getElementById('base-price').textContent.replace('$', '')) || 0,
                addonTotal: parseFloat(document.getElementById('addon-total').textContent.replace('$', '')) || 0,
                discountAmount: parseFloat(document.getElementById('discount-amount').textContent.replace('-$', '')) || 0,
                taxAmount: parseFloat(document.getElementById('tax-amount').textContent.replace('$', '')) || 0,
                notes: document.getElementById('special-notes').value || '',
                date: new Date().toISOString(),
                status: 'preview'
            };
            
            displayProposal(estimate);
            showView('proposals');
        }
        
        // Quick Setup from Hourly Rate
        function calculateFromHourlyRate() {
            const hourlyRate = parseFloat(document.getElementById('hourly-rate').value) || 25;
            // Calculate suggested rates based on hourly rate
            // Bedroom: ~30 min = hourly/2
            // Bathroom: ~45 min = hourly * 0.75
            // Kitchen: ~1 hr = hourly
            // Living: ~40 min = hourly * 0.67
            document.getElementById('rate-bedroom').value = Math.round(hourlyRate * 0.5);
            document.getElementById('rate-bathroom').value = Math.round(hourlyRate * 0.75);
            document.getElementById('rate-kitchen').value = Math.round(hourlyRate);
            document.getElementById('rate-living').value = Math.round(hourlyRate * 0.67);
        }
        
        function applyQuickSetup() {
            calculateFromHourlyRate();
            showToast('Rates auto-filled based on your hourly rate!', 'success');
        }
        
        // Getting Started Guide
        function checkShowGettingStarted() {
            const dismissed = localStorage.getItem('cq_getting_started_dismissed');
            const hasEstimates = appData.estimates.length > 0;
            const gettingStartedCard = document.getElementById('getting-started-card');
            
            if (!dismissed && !hasEstimates && gettingStartedCard) {
                gettingStartedCard.style.display = 'block';
            }
        }
        
        function dismissGettingStarted() {
            localStorage.setItem('cq_getting_started_dismissed', 'true');
            const card = document.getElementById('getting-started-card');
            if (card) {
                card.style.display = 'none';
            }
        }
        
        // Utility Functions
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type === 'error' ? 'error' : ''} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function printEstimate() {
            window.print();
        }
        
        function showKeyboardShortcuts() {
            alert('Keyboard Shortcuts:\n\n' +
                '? - Show this help\n' +
                'Esc - Close modals\n' +
                'Ctrl+S - Save current form\n' +
                'Ctrl+N - New estimate');
        }

        // Handle window resize for mobile responsiveness
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('show');
                document.getElementById('mobile-backdrop').classList.remove('show');
                document.body.style.overflow = '';
            }
        });
    </script>
</body>
</html>